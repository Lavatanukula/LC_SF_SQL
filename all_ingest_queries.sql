<br> </br>
TRUNCATE TABLE WOOD_PELLET_VENDORS_W_IDS_PREPARED_BY_VENDOR_ID;
<br> </br>
TRUNCATE TABLE PDQ_VF_PREP;
<br> </br>
TRUNCATE TABLE WOOD_PELLET_VENDORS_W_NUMBER_BY_VENDOR_ID;
<br> </br>
TRUNCATE TABLE WOOD_PELLET_VENDORS_PREPARED_W_NAME;
<br> </br>
TRUNCATE TABLE VENDOR_BY_FREIGHT_TERM_WINDOWS;
<br> </br>
TRUNCATE TABLE VOLUMNE_REBATE_STACKED;
<br> </br>
TRUNCATE TABLE DC_3PL_DC_VARIABLE_ITEM_MAPPING_PROD_CAT_PREPARED;
<br> </br>
TRUNCATE TABLE SCANDOWNS_FILTER_BY_YEAR;
<br> </br>
TRUNCATE TABLE VOLUME_REBATE_2022_W_RECEIPTS_FOLD;
<br> </br>
TRUNCATE TABLE VOLUME_REBATE_2021_FOLD_STACKED;
<br> </br>
TRUNCATE TABLE VF_DEFECTIVE_PREP;
<br> </br>
TRUNCATE TABLE TSC_DELIVERY_STORE_COUNT_PREPARED_BY_YEAR_QUARTER;
<br> </br>
TRUNCATE TABLE TSC_DELIVERY_PREPARED;
<br> </br>
TRUNCATE TABLE MARKDOWNS_FILTER_BY_YEAR;
<br> </br>
TRUNCATE TABLE SCANDOWNS_FLAG_CLEAN;
<br> </br>
TRUNCATE TABLE SHRINK_DEFECTIVE_2020;
<br> </br>
TRUNCATE TABLE NEW_STORE_DISCOUNT_PREPARED_PREPARED;
<br> </br>
TRUNCATE TABLE SHRINK_THEFT_INVENTORY_ACTUAL_SHRINK;
<br> </br>
TRUNCATE TABLE THEFT_V2_PREPARED_STACKED;
<br> </br>
TRUNCATE TABLE UNSELLABLES_AND_MISC_STACKED;
<br> </br>
TRUNCATE TABLE OMNI_LM_MULTICHANNEL_SALVAGE_STACKED;
<br> </br>
TRUNCATE TABLE TLM_SHIPMENT_ACTUAL_DELIVERY_DATE;
<br> </br>
TRUNCATE TABLE DC_3PL_LOCATION_MAPPING_PREPARED;
<br> </br>
TRUNCATE TABLE DC_3PL_PNL_OMNI_FULFILLMENT_BY_COST_CENTER;
<br> </br>
TRUNCATE TABLE INVENTORYDETAIL;
<br> </br>
TRUNCATE TABLE ARTICLE_W_SHP_DIM_PREP;
<br> </br>
TRUNCATE TABLE FREIGHTDETAIL_PREPARED_JOINED;
<br> </br>
TRUNCATE TABLE ROADIE_TRACTOR_SUPPLY_INVOICE_STACKED_JOINED;
<br> </br>
TRUNCATE TABLE DC_3PL_OUTBOUND_PRODUCTIVITY_RATE_BY_PRODUCT_SEGMENT_PREPARED;
<br> </br>
TRUNCATE TABLE DC_3PL_WEIGHTED_AVERAGE_LABOR_RATES_BY_DC_20TO22_PREPARED;
<br> </br>
TRUNCATE TABLE DUTY_PREPARED_PREPARED_1_FILTERED_STACKED;
<br> </br>
TRUNCATE TABLE facility_inbound_20to22;
<br> </br>
TRUNCATE TABLE facility_outbound_20to22;
<br> </br>
TRUNCATE TABLE FEDEX_UPS_PREPARED_FILTERED;
<br> </br>
TRUNCATE TABLE INVENTORY_BY_ARTICE_WEEK;
<br> </br>
TRUNCATE TABLE ITEM_SHIPPING_DIMENSION_BY_ARTICLE_NO_DIM;
<br> </br>
TRUNCATE TABLE LM_IMPORT_MANIFEST_PREPARED_STACKED_DISTINCT;
<br> </br>
TRUNCATE TABLE LM_PRICECYTS_202211_SF_STACKED_PREPARED;
<br> </br>
TRUNCATE TABLE MIXING_CENTER_CREDIT;
<br> </br>
TRUNCATE TABLE lm_pdq_prep;
<br> </br>
TRUNCATE TABLE FREIGHT_DETAIL_SMALL_LTL;
<br> </br>
TRUNCATE TABLE OMNICHANNEL_SALES_STATUS_PREPARED;
<br> </br>
TRUNCATE TABLE BATTERY_CORE;
<br> </br>
TRUNCATE TABLE BOOTH_RENTAL_STACKED_PREPARED_BY_PARENT_VENDOR_INT;
<br> </br>
TRUNCATE TABLE DC_3PL_INBOUND_PRODUCTIVITY_RATE_BY_PRODUCT_SEGMENT_PREPARED;
<br> </br>
TRUNCATE TABLE DC_3PL_ITEM_MAPPING_TO_PRODUCT_SEGMENT_PREPARED;
<br> </br>
TRUNCATE TABLE DC_3PL_PANDL_FIXED_COST_BY_COST_CENTER;
<br> </br>
TRUNCATE TABLE DC_3PL_PANDL_VARIABLE_COST_BY_COST_CENTER;
<br> </br>
TRUNCATE TABLE DC_SHRINK_PREPARED_STACKED;
<br> </br>
TRUNCATE TABLE FREIGHT_DETAIL_ROADIE_PREPARED;
<br> </br>
TRUNCATE TABLE IMPORT_CHARGE_BY_YEAR_PERIOD;
<br> </br>
TRUNCATE TABLE IMPORT_DEST_MAPPING_PREP;
<br> </br>
TRUNCATE TABLE IMPORT_ORIGIN_MAPPING_PREP_STACKED_WINDOWS_PREPARED;
<br> </br>
TRUNCATE TABLE SCANDOWN_NEW_PREPARED_FILTERED_JOINED_FILTERED_STG;
<br> </br>
TRUNCATE TABLE LM_NEW_MARKDOWN_FLAG_GRP;
<br> </br>
TRUNCATE TABLE LM_NEW_SCANDOWN_FLAG_JOINED_SKU;
<br> </br>
TRUNCATE TABLE LM_VENDOR_SUPPORT_FAST_RATES_STACKED;
<br> </br>
TRUNCATE TABLE LM_VENDOR_SUPPORT_RATES_STACKED;
<br> </br>
TRUNCATE TABLE COMPANY_PARENT_VENDOR;
<br> </br>
TRUNCATE TABLE OMS_ITEM_PREPARED_BY_OMS_ITEM_ID;
<br> </br>
TRUNCATE TABLE COMPANY_PARENT_VENDOR_PREPARED;
<br> </br>
TRUNCATE TABLE CASH_DISCOUNTS_PREPARED_FILTERED;
<br> </br>
TRUNCATE TABLE CASH_DISCOUNTS_PREPARED_FILTERED_PREPARED;
<br> </br>
TRUNCATE TABLE DC_3PL_LOCATION_MAPPING_PREPARED;
<br> </br>
TRUNCATE TABLE FINANCIAL_INVENTORY_YP_PREPARED_FILTERED_JOINED;
<br> </br>
TRUNCATE TABLE PRICE_CUTS_2021_2020_PREPARED;
<br> </br>
TRUNCATE TABLE ROADIE_TRACTOR_SUPPLY_INVOICE_STACKED_BY_TRACKING_NUMBER;
<br> </br>
TRUNCATE TABLE TSC_FACILITIES_PREP_STACKED;
<br> </br>
TRUNCATE TABLE TSC_FACILITIES_FINAL;
<br> </br>
TRUNCATE TABLE VENDOR_COMPLIANCE_PIVOT;
<br> </br>
TRUNCATE TABLE COMPANY_ARTICLE_W_BUYER;
<br> </br>
TRUNCATE TABLE DC_3PL_PANDL_PREPARED_BY_COST_CENTER_STACKED;
<br> </br>
TRUNCATE TABLE lm_pop_prep;

<br> 
--WOOD_PELLET_VENDORS_W_IDS_PREPARED_BY_VENDOR_ID
</br>
insert into WOOD_PELLET_VENDORS_W_IDS_PREPARED_BY_VENDOR_ID
SELECT   VENDOR_ID
FROM   (SELECT  VENDOR_ID
        FROM  LC_WOOD_PELLET_VENDORS
         ) _Stacked
GROUP  BY VENDOR_ID;

<br>
--WOOD_PELLET_VENDORS_W_NUMBER_BY_VENDOR_ID 
</br>  

insert into WOOD_PELLET_VENDORS_W_NUMBER_BY_VENDOR_ID
SELECT  VENDOR_ID
FROM   (SELECT  ID,
              REPLACE(SUBSTR(F1,1,CHARINDEX('-',F1)),'-','') AS VENDOR_ID
        FROM   LC_FACILITY_TABLES_WOOD_PELLET_VENDORS
        WHERE  id >= 160) _Before_grouping
GROUP  BY VENDOR_ID ;

 <br>
--Creatting Roadie Prepared Table as per End table 
</br>

CREATE OR REPLACE TEMP TABLE   ROADIE_REFRESH_CSV_PREPARED_TEMP
AS
SELECT 
    NULL  AS "Delivery_Date",
   "Delivery_Date_parsed",
   "Pick_up_Store_Number",
   TRIM("Tracking_Number") AS "Tracking_Number",
   TRIM(IFF("TSC_Order_Number" IS NULL ,"TSC_ORDER_NUMBER_(2)","TSC_Order_Number")) AS "TSC_Order_Number",
   "Customer_Name",
   "SKU",
   "SKU_Description",
   "Ship_to_Zip_Code",
   "Service_Level",
    "Distance_Shipped",
    "Roadie_Total_Cost",
   "Store_Charge_to_customer",
   "Store_CostCharge_to_Store",
   "SSC_Subsidized"
FROM
(
  SELECT 
    "DELIVERY_DATE" AS "Delivery_Date",
    CASE WHEN "DELIVERY_DATE" LIKE '%/%' THEN  SPLIT_PART("DELIVERY_DATE",'/',1) 
    ELSE SPLIT_PART("DELIVERY_DATE",'-',1) END AS "Month", 
    LPAD("Month",2,0) AS "Month_",
    CASE WHEN "DELIVERY_DATE" LIKE '%/%' THEN  SPLIT_PART("DELIVERY_DATE",'/',2) 
    ELSE SPLIT_PART("DELIVERY_DATE",'-',2) END AS "day",
    LPAD("day",2,0) AS "day_",
    CASE WHEN "DELIVERY_DATE" LIKE '%/%' THEN  SPLIT_PART("DELIVERY_DATE",'/',3)
    ELSE SPLIT_PART("DELIVERY_DATE",'-',3) END AS "year_", 
    CASE WHEN LEN("year_")=2 THEN CONCAT('20',"year_") ELSE "year_" END  AS "year_Full",
      CONCAT("year_Full",'-',"Month_",'-',"day_") AS "New_Delivery_Date",
      CONCAT("year_Full",'-',"Month_",'-',"day_",space(1),'00:00:00')  AS "Delivery_Date_parsed",
    "PICK_UP_STORE_NUMBER" AS "Pick_up_Store_Number",
    "TRACKING_NUMBER" AS "Tracking_Number",
    "TSC_ORDER_NUMBER" AS "TSC_Order_Number",
    "TSC_ORDER_NUMBER_(2)" AS "TSC_ORDER_NUMBER_(2)", 
    "CUSTOMER_NAME" AS "Customer_Name",
    "SKU" AS "SKU",
    "SKU_DESCRIPTION" AS "SKU_Description",
    "SHIP_TO_ZIP_CODE" AS "Ship_to_Zip_Code",
    "SERVICE_LEVEL" AS "Service_Level",
    TRY_TO_NUMBER("DISTANCE_SHIPPED") AS "Distance_Shipped",
    REPLACE(REPLACE(REPLACE("ROADIE_TOTAL_COST", '$', ''), ',', ''), '-', '')  AS "Roadie_Total_Cost",
    REPLACE(REPLACE("STORE_CHARGE_TO_CUSTOMER",'$',''),'-','') AS "Store_Charge_to_customer",
    REPLACE(REPLACE("STORE_COST_CHARGE_TO_STORE",'$',''),'-','') AS "Store_CostCharge_to_Store",
    "SSC_SUBSIDIZED" AS "SSC_Subsidized"
  FROM ROADIE_REFRESH_CSV_PREPARED
)A
WHERE "Pick_up_Store_Number"!='xxx' AND ((CAST("Delivery_Date" AS VARCHAR) != '' OR CAST("Delivery_Date" AS VARCHAR) IS NULL AND '' IS NOT NULL OR CAST("Delivery_Date" AS VARCHAR) IS NOT NULL AND '' IS NULL) AND "Delivery_Date" IS NOT NULL)  AND ((CAST("Tracking_Number" AS VARCHAR) != '' OR CAST("Tracking_Number" AS VARCHAR) IS NULL AND '' IS NOT NULL OR CAST("Tracking_Number" AS VARCHAR) IS NOT NULL AND '' IS NULL) AND "Tracking_Number" IS NOT NULL)

  <br>
-- Load New Data to ROADIE_TRACTOR_SUPPLY_INVOICE_STACKED
  </br>

MERGE INTO ROADIE_TRACTOR_SUPPLY_INVOICE_STACKED d 
USING (SELECT * FROM ROADIE_REFRESH_CSV_PREPARED_TEMP WHERE TRIM("Tracking_Number") IS NOT NULL) s ON TRIM(d.TRACKING_NUMBER) = TRIM(s."Tracking_Number")
WHEN NOT MATCHED  THEN    INSERT(DELIVERY_DATE,DELIVERY_DATE_PARSED,PICK_UP_STORE_NUMBER,TRACKING_NUMBER,TSC_ORDER_NUMBER,CUSTOMER_NAME,SKU,SKU_DESCRIPTION,SHIP_TO_ZIP_CODE,SERVICE_LEVEL,DISTANCE_SHIPPED,ROADIE_TOTAL_COST,STORE_CHARGE_TO_CUSTOMER,STORE_COST_CHARGE_TO_STORE,SSC_SUBSIDIZED) VALUES (s."Delivery_Date",s."Delivery_Date_parsed",s."Pick_up_Store_Number",s."Tracking_Number",s."TSC_Order_Number",s."Customer_Name",s."SKU",s."SKU_Description",s."Ship_to_Zip_Code",s."Service_Level",s."Distance_Shipped",s."Roadie_Total_Cost",s."Store_Charge_to_customer",s."Store_CostCharge_to_Store",s."SSC_Subsidized");

<br>
--WOOD_PELLET_VENDORS_PREPARED_W_NAME
</br>
insert into WOOD_PELLET_VENDORS_PREPARED_W_NAME
SELECT  VENDOR_NAME
FROM   (SELECT  ID,
               F1 AS VENDOR_NAME
        FROM   LC_FACILITY_TABLES_WOOD_PELLET_VENDORS
        WHERE  ID < 160) _Before_grouping
GROUP  BY VENDOR_NAME;

<br>
--VENDOR_BY_FREIGHT_TERM_WINDOWS 
</br>
insert into VENDOR_BY_FREIGHT_TERM_WINDOWS
SELECT  *
FROM   (SELECT  "VENDOR_ID","FREIGHT_TERMS_CODE",
               Row_number()OVER (partition BY vendor_id ORDER BY freight_terms_code DESC) AS rownumber
        FROM   (SELECT  "VENDOR_ID","FREIGHT_TERMS_CODE" FROM  EDW.VW_COMPANY_VENDOR ) AS vendor_by_freight_term) AS vendor_by_freight_term_windows
WHERE  rownumber = 1;

<br>
--VOLUMNE_REBATE_STACKED
</br>
insert into VOLUMNE_REBATE_STACKED
SELECT  CAST(VENDOR_ID  AS INT)                      AS vendor_id,
        2020                          AS Merch_Year,
       Sum(FULL_YEAR_EARNED_REBATES) AS allocation_value
FROM   LC_VOLUME_REBATES_2020v2
GROUP  BY VENDOR_ID,
          Merch_Year        
UNION ALL
SELECT  vendor_id,
       cast(merch_year  as INT)           AS Merch_Year,
       Sum(allocation_value) AS allocation_value
        FROM   (
                 SELECT "Vendor #" as VENDOR_ID,
                         "Full Year Earned Rebates" as allocation_value,
                         "Merch_Year" as merch_year
                  FROM VOLUME_REBATE_FULL_YEAR_STACKED
                 ) volume_rebate_full_year_stacked
GROUP  BY vendor_id,
          merch_year;

<br>
--DC_3PL_DC_VARIABLE_ITEM_MAPPING_PROD_CAT_PREPARED
</br>

insert into DC_3PL_DC_VARIABLE_ITEM_MAPPING_PROD_CAT_PREPARED
SELECT  "Category_Number",
        "Primary_Product_Segment",
		"Secondary_Product_Segment"        
FROM  "DC_VARIABLE_ITEM_TO_PROD_CAT_PREPARED";

<br>
--PDQ_VF_PREP
</br>
insert into PDQ_VF_PREP
select  * from  LC_PDQ_VF_PREP ;

<br>
--SCANBACKS_MAPPING_PREP_STACKED_WINDOWS_PREPARED
</br>
CREATE OR REPLACE TEMP TABLE SCANBACKS_MAPPING_PREP_STACKED_WINDOWS_PREPARED
 AS
 SELECT     "MD" ,
            "VENDOR",
            "Type",
            "year",
             rownumber
 FROM   (
                            SELECT  "MD",
                                   "VENDOR",
                                   "Type",
                                   "year",
                                    Row_number() OVER(partition BY "MD" ,"year" ORDER BY "VENDOR" )AS rownumber
                             FROM   "LC_SCANBACKS_MAPPING_PREP_STACKED"

        )D 
WHERE rownumber=1;

<br>
--SCANDOWNS_FILTER_BY_YEAR
</br>												
										
INSERT INTO SCANDOWNS_FILTER_BY_YEAR
SELECT   a."Year"             AS merch_year,
         a."year_period_new" AS year_period,
         a."Vendor_No"       AS vendor_id ,
         1                  AS scandown_flag,
         Sum("Total")        AS allocation_value

FROM "LC_MARKDOWNS_2021_2022_PREPARED_STACKED"  a
LEFT JOIN SCANBACKS_MAPPING_PREP_STACKED_WINDOWS_PREPARED  b
ON       a."Year"=b."year" AND b."MD" =a."Log_No"
WHERE b."Type"='S' 
GROUP BY 1,2,3,4 ;

<br>		 
--VOLUME_REBATE_2022_W_RECEIPTS_FOLD
</br>
insert into  VOLUME_REBATE_2022_W_RECEIPTS_FOLD
SELECT
       parentvendor,
       childvendor,
       january_sap_net_receipts_fpv,
       february_sap_net_receipts_fpv,
       march_sap_net_receipts_fpv,
       april_sap_net_receipts_fpv,
       may_sap_net_receipts_fpv,
       year,
       avg_per,
       CASE
              WHEN month = 'JAN' THEN '01'
              WHEN month = 'FEB' THEN '02'
              WHEN month = 'MAR' THEN '03'
              WHEN month = 'APR' THEN '04'
              WHEN month = 'MAY' THEN '05'
       END AS month,
       CASE
              WHEN month = 'JAN' THEN Concat(year, '01')
              WHEN month = 'FEB' THEN Concat(year, '02')
              WHEN month = 'MAR' THEN Concat(year, '03')
              WHEN month = 'APR' THEN Concat(year, '04')
              WHEN month = 'MAY' THEN Concat(year, '05')
       END AS year_month,
       volume_rebate
FROM
       (
              SELECT
                     parentvendor,
                     childvendor,
                     january_sap_net_receipts_fpv,
                     february_sap_net_receipts_fpv,
                     march_sap_net_receipts_fpv,
                     april_sap_net_receipts_fpv,
                     may_sap_net_receipts_fpv,
                     year,
                     avg_per,
                     month,
                     volume_rebate
              FROM
                     (
                            SELECT
                                   parentvendor,
                                   childvendor,
                                   january_sap_net_receipts_fpv,
                                   february_sap_net_receipts_fpv,
                                   march_sap_net_receipts_fpv,
                                   april_sap_net_receipts_fpv,
                                   may_sap_net_receipts_fpv,
                                   year,
                                   avg_per,
                                   Cast(COALESCE(may_sap_net_receipts_fpv, '0') * COALESCE(avg_per, '0') AS DECIMAL(38, 4) ) AS may,
                                   Cast(COALESCE(march_sap_net_receipts_fpv, '0') * COALESCE(avg_per, '0') AS DECIMAL(38, 4)) AS mar,
                                   Cast(COALESCE(april_sap_net_receipts_fpv, '0') * COALESCE(avg_per, '0') AS DECIMAL(38, 4) ) AS apr,
                                   Cast(COALESCE(january_sap_net_receipts_fpv, '0') * COALESCE(avg_per, '0') AS DECIMAL(38, 4)) AS jan,
                                   Cast(COALESCE(february_sap_net_receipts_fpv, '0') * COALESCE(avg_per, '0') AS DECIMAL(38, 4)) AS feb
                            FROM
                                   (
                                          SELECT
                                                 vr."Parent Vendor" AS parentvendor,
                                                 vr."Child Vendor" AS childvendor,
                                                 vr."January SAP Net Receipts (FPV)" AS january_sap_net_receipts_fpv,
                                                 vr."February SAP Net Receipts (FPV)" AS february_sap_net_receipts_fpv,
                                                 vr."March SAP Net Receipts (FPV)" AS march_sap_net_receipts_fpv,
                                                 vr."April SAP Net Receipts (FPV)" AS april_sap_net_receipts_fpv,
                                                 vr."May SAP Net Receipts (FPV)" AS may_sap_net_receipts_fpv,
                                                 '2022' AS year,
                                                 rkp."avg_per" as avg_per
                                          FROM
                                                 "LC_VOLUME_REBATE_2022" vr
                                                 LEFT JOIN "LC_REBATE_KEY_2022" rkp ON vr."Parent Vendor" = rkp."parent_vendor"
                                                 where vr."Child Vendor" is not null
                                   ) volume_rebate_2022_w_receipts_prepared_joined
                     ) AS volume_rebate_2022_w_receipts_fold UNPIVOT (
                            volume_rebate FOR month IN (
                                   jan,
                                   feb,
                                   mar,
                                   apr,
                                   may
                            )
                     ) AS _prepared
       ) Final
WHERE
       YEAR >= 2020;
<br>
--VOLUME_REBATE_2021_FOLD_STACKED
</br>     
insert into VOLUME_REBATE_2021_FOLD_STACKED
              SELECT       parentvendor,
                            year,
                            CASE
              WHEN month ='JAN' THEN '01'
              WHEN month ='FEB' THEN '02'
              WHEN month ='MAR' THEN '03'
              WHEN month ='APR' THEN '04'
              WHEN month ='MAY' THEN '05'
              WHEN month ='JUN' THEN '06'
              WHEN month ='JUL' THEN '07'
              WHEN month ='AUG' THEN '08'
              WHEN month ='SEP' THEN '09'
              WHEN month ='OCT' THEN '10'
              WHEN month ='NOV' THEN '11'
              WHEN month ='DEC' THEN '12'
       END AS month_new,
       month,
        CASE
              WHEN month ='JAN' THEN  Concat(year,'01')
              WHEN month ='FEB' THEN Concat(year,'02')
              WHEN month ='MAR' THEN Concat(year,'03')
              WHEN month ='APR' THEN Concat(year,'04')
              WHEN month ='MAY' THEN Concat(year,'05')
              WHEN month ='JUN' THEN Concat(year,'06')
              WHEN month ='JUL' THEN Concat(year,'07')
              WHEN month ='AUG' THEN Concat(year,'08')
              WHEN month ='SEP' THEN Concat(year,'09')
              WHEN month ='OCT' THEN Concat(year,'10')
              WHEN month ='NOV' THEN Concat(year,'11')
              WHEN month ='DEC' THEN Concat(year,'12')
       END AS year_month,
       volume_rebate
                     FROM (
                                   select  "Parent Vendor" AS parentvendor ,
                                   "Jan - VR Actual" AS Jan,
                                   "Feb - VR Actual" AS Feb,
                                   "Mar - VR Actual" AS Mar,
                                   "Apr - VR Actual" AS Apr,
                                   "May - VR Actual" AS May,
                                   "Jun - VR Actual" AS Jun,
                                   "Jul - VR Actual" AS Jul,
                                   "Aug - VR Actual" AS Aug,
                                   "Sep - VR Actual" AS Sep,
                                   "Oct - VR Actual" AS Oct,
                                   "Nov - VR Actual" AS Nov,
                                   "Dec - VR Actual" AS Dec,
                                   '2021' AS year
                             FROM "LC_VOLUME_REBATE_2021_PREPARED" 
                            )A
                          UNPIVOT ( volume_rebate FOR month IN (Jan,                                                                                                                                                  Feb,                                                                                                                                                   Mar,                                                                                                                                                      Apr,                                                                                                                                                      May,                                                                                                                                                  Jun,                                                                                                                                                  Jul,                                                                                                                                                  Aug,                                                                                                                                                  Sep,                                                                                                                                                      Oct,
                                                                          Nov,                                                                                                                                                  Dec ) 
                          )A 

                UNION ALL 

                SELECT   parentvendor,
                            year,
                            CASE
              WHEN month ='JAN' THEN '01'
              WHEN month ='FEB' THEN '02'
              WHEN month ='MAR' THEN '03'
              WHEN month ='APR' THEN '04'
              WHEN month ='MAY' THEN '05'
              WHEN month ='JUN' THEN '06'
              WHEN month ='JUL' THEN '07'
              WHEN month ='AUG' THEN '08'
              WHEN month ='SEP' THEN '09'
              WHEN month ='OCT' THEN '10'
              WHEN month ='NOV' THEN '11'
              WHEN month ='DEC' THEN '12'
       END AS month_new,
       month,
        CASE
              WHEN month ='JAN' THEN  Concat(year,'01')
              WHEN month ='FEB' THEN Concat(year,'02')
              WHEN month ='MAR' THEN Concat(year,'03')
              WHEN month ='APR' THEN Concat(year,'04')
              WHEN month ='MAY' THEN Concat(year,'05')
              WHEN month ='JUN' THEN Concat(year,'06')
              WHEN month ='JUL' THEN Concat(year,'07')
              WHEN month ='AUG' THEN Concat(year,'08')
              WHEN month ='SEP' THEN Concat(year,'09')
              WHEN month ='OCT' THEN Concat(year,'10')
              WHEN month ='NOV' THEN Concat(year,'11')
              WHEN month ='DEC' THEN Concat(year,'12')
       END AS year_month,
       volume_rebate FROM (
                                   SELECT  PARENT_VENDOR as parentvendor,
                                   JAN_VR_ACTUAL AS Jan,
                                   FEB_VR_ACTUAL AS Feb,
                                   MAR_VR_ACTUAL AS Mar,
                                   APR_VR_ACTUAL AS Apr,
                                   MAY_VR_ACTUAL AS May,
                                   JUN_VR_ACTUAL AS Jun,
                                   JUL_VR_ACTUAL AS Jul,
                                   AUG_VR_ACTUAL AS Aug,
                                   SEP_VR_ACTUAL AS Sep,
                                   OCT_VR_ACTUAL AS Oct,
                                   NOV_VR_ACTUAL AS Nov,
                                   DEC_VR_ACTUAL AS Dec,
                                   '2020' AS year
                           FROM "LC_VOLUME_REBATE_2020_PREPARED"
                           WHERE "PARENT_VENDOR" IS NOT NULL 
                            )
                           AB
                            UNPIVOT ( volume_rebate FOR month IN (Jan, Feb, Mar, Apr, May,Jun,Jul,Aug,Sep,Oct,Nov,Dec ) )A

<br>                 
--VF_DEFECTIVE_PREP
</br> 
 
INSERT INTO  VF_DEFECTIVE_PREP
SELECT   "article"
        ,"vendor"
        ,"qty"
        ,"def_allow"
        ,"qtr"
        , CAST(Ltrim(Replace(LEFT("qtr",2),'Q','')) AS INT) AS qtr_0
        , CAST(RIGHT("qtr",4) AS  INT) AS year
        , CAST(CONCAT(RIGHT("qtr",4),Replace(LEFT("qtr",2),'Q','')) AS INT) AS year_quarter     
FROM "LC_VF_DEFECTIVE_PREPARED_STACKED" 
UNION ALL
SELECT   "article"
        ,"vendor"
        ,"qty"
        ,"def_allow"
        , REPLACE("qtr",'Q1 2024','Q2 2024') AS "qtr"
        , 2 AS qtr_0
        , 2024 AS year
        , 20242 AS year_quarter     
FROM "LC_VF_DEFECTIVE_PREPARED_STACKED" 
WHERE "qtr" ='Q1 2024';

<br>
--TSC_DELIVERY_STORE_COUNT_PREPARED_BY_YEAR_QUARTER
</br>
insert into  TSC_DELIVERY_STORE_COUNT_PREPARED_BY_YEAR_QUARTER 
SELECT  year_quarter,
       Sum(deliv_count) AS Deliv_Count_sum,
       Count(*)         AS count
FROM   (SELECT  Concat("Year", "Fiscal_Quarter") AS year_quarter,
               Cast(Replace(Replace("Deliv_Count", ',', ''), '$', '') AS NUMBER)AS Deliv_Count
        FROM   "LC_TSC_DELIVERY_STORE_COUNT_STACKED"
        WHERE  "Method" = 'Tractor Supply Delivery' AND "Year" >= 2020 )A       
GROUP  BY year_quarter ;

<br>
--TSC_DELIVERY_PREPARED
</br> 
 
INSERT INTO TSC_DELIVERY_PREPARED
SELECT 
        CONCAT('2023',RIGHT("YEAR_PERIOD",2)) AS "YEAR_PERIOD",
        '2023' AS "MERCH_YEAR",
        "TSC_DELIVERY" AS  "ALLOCATION_VALUE",
        1 AS "TSC_DELIVERY_FLAG"
FROM   "TSC_DELIVERY"
WHERE MERCH_YEAR >=2022 AND MERCH_YEAR <=2022
UNION ALL 
SELECT 
        CONCAT('2024',RIGHT("YEAR_PERIOD",2)) AS "YEAR_PERIOD",
        '2024' AS "MERCH_YEAR",
        "TSC_DELIVERY" AS  "ALLOCATION_VALUE",
        1 AS "TSC_DELIVERY_FLAG"
FROM   "TSC_DELIVERY"
WHERE MERCH_YEAR >=2022 AND MERCH_YEAR <=2022
UNION ALL
SELECT  "YEAR_PERIOD",
        "MERCH_YEAR",
        "TSC_DELIVERY" AS  "ALLOCATION_VALUE",
        1 AS "TSC_DELIVERY_FLAG"
FROM   "TSC_DELIVERY"
WHERE "MERCH_YEAR" >=2020;


<br>
--MARKDOWNS_FILTER_BY_YEAR
</br>
INSERT INTO "MARKDOWNS_FILTER_BY_YEAR"
SELECT         a."Year"             AS merch_year,
                a."year_period_new"  AS year_period,
                a."Vendor_No"        AS vendor_id ,
                1                    AS markdown_flag,
                Sum(a."Total")        AS allocation_value FROM 
(SELECT  "Year" ,
        "year_period_new",
        "Log_No",
        "Vendor_No",
        "Total"
FROM   "LC_MARKDOWNS_2021_2022_PREPARED_STACKED"
WHERE "Year" >=2020 )A
LEFT JOIN 
(
                        SELECT  * FROM (
                        SELECT  "MD" ,
                                        "VENDOR",
                                        "Type",
                                        "year",
                                        Row_number()OVER(partition BY "MD" ,"year" ORDER BY "VENDOR" )AS rownumber
                        FROM            (
                                                        SELECT  "MD",
                                                                "VENDOR",
                                                                "Type",
                                                                "year"                                                            
                                                        FROM   "LC_SCANBACKS_MAPPING_PREP_STACKED"
                                                        WHERE   "year" >=2020
                                        )D )DA
                        WHERE  rownumber =1 
)B 
ON       a."Year"=b."year" 
AND      a."Log_No" =b."MD"
WHERE b."Type" != 'S' OR b."Type" IS NULL AND 'S' IS NOT NULL OR b."Type" IS NOT NULL AND 'S' IS NULL
GROUP BY         a."Year",            
                a."year_period_new",  
                a."Vendor_No"    ;   


<br>
--SCANDOWNS_FLAG_CLEAN
</br>
  INSERT INTO  SCANDOWNS_FLAG_CLEAN
  SELECT  "year_period_new","Vendor_No","SKU_ID" ,
   to_double(try_to_numeric ("SKU_ID" )) "article_clean",CAST(try_to_numeric ("SKU_ID" ) AS INT) AS "article_int"
  FROM 
  (
  SELECT 
    a."year_period_new"  
    ,a."Vendor_No"
    ,b."SKU_1" 
    ,b."SKU_2" 
    ,b."SKU_3" 
    ,b."SKU_4" 
    ,b."SKU_5" 
    ,b."SKU_6" 
    ,b."SKU_7" 
    ,b."SKU_8" 
    ,b."SKU_9" 
    ,b."SKU_10"
    ,b."SKU_11"
    ,b."SKU_12"
    ,b."SKU_13"
    ,b."SKU_14"
    ,b."SKU_15"
    ,b."SKU_16"
    ,b."SKU_17"
    ,b."SKU_18"
    ,b."SKU_19"
    ,b."SKU_20"
    ,b."SKU_21"
    ,b."SKU_22"
    ,b."SKU_23"
    ,b."SKU_24"
    ,b."SKU_25"
    ,b."SKU_26"
    ,b."SKU_27"
    ,b."SKU_28"
    ,b."SKU_29"
    ,b."SKU_30"
    ,b."SKU_31"
    ,b."SKU_32"
    ,b."SKU_33"
    ,b."SKU_34"
    ,b."SKU_35"
    ,b."SKU_36"
    ,b."SKU_37"
    ,b."SKU_38"
    ,b."SKU_39"
    ,b."SKU_40"
    ,b."SKU_41"
    ,b."SKU_42"
    ,b."SKU_43"
    ,b."SKU_44"
    ,b."SKU_45"
    ,b."SKU_46"
    ,b."SKU_47"
    ,b."SKU_48"
    ,b."SKU_49"
    ,b."SKU_50"
    ,b."SKU_51"
    ,b."SKU_52"
    ,b."SKU_53"
    ,b."SKU_54"
    ,b."SKU_55"
    ,b."SKU_56"
    ,b."SKU_57"
    ,b."SKU_58"
    ,b."SKU_59"
    ,b."SKU_60"
    ,b."SKU_61"
    ,b."SKU_62"
    ,b."SKU_63"
    ,b."SKU_64"
    ,b."SKU_65"
    ,b."SKU_66"
    ,b."SKU_67"
    ,b."SKU_68"
    ,b."SKU_69"
    ,b."SKU_70"

                FROM 
                (SELECT  "Year" ,
                       "year_period_new",
                       "Log_No",
                       "Vendor_No",
                       	"Total"
                FROM   "LC_MARKDOWNS_2021_2022_PREPARED_STACKED" )A
                LEFT JOIN 
                (
                                       SELECT * FROM (
                                       SELECT  *,
                                                       Row_number()OVER(partition BY "MD" ,"year" ORDER BY "VENDOR" )AS rownumber
                                       FROM            (
                                                                       SELECT DISTINCT *                                                         
                                                                        FROM   "LC_SCANBACKS_MAPPING_PREP_STACKED"
                                                       )D )DA
                                      WHERE  rownumber =1 
                )B 
        ON       a."Year"=b."year" 
        AND      a."Log_No" =b."MD"
        WHERE b."Type"= 'S'
        GROUP BY 
        a."Vendor_No",
        a."year_period_new",b."SKU_1" ,b."SKU_2" ,b."SKU_3" ,b."SKU_4" ,b."SKU_5" ,b."SKU_6" ,b."SKU_7" ,b."SKU_8" ,b."SKU_9",b."SKU_10",b."SKU_11"
       ,b."SKU_12",b."SKU_13",b."SKU_14",b."SKU_15",b."SKU_16",b."SKU_17",b."SKU_18",b."SKU_19",b."SKU_20",b."SKU_21",b."SKU_22",b."SKU_23",b."SKU_24"
       ,b."SKU_25",b."SKU_26",b."SKU_27",b."SKU_28",b."SKU_29",b."SKU_30",b."SKU_31",b."SKU_32",b."SKU_33",b."SKU_34",b."SKU_35",b."SKU_36",b."SKU_37"
       ,b."SKU_38",b."SKU_39",b."SKU_40",b."SKU_41",b."SKU_42",b."SKU_43",b."SKU_44",b."SKU_45",b."SKU_46",b."SKU_47",b."SKU_48",b."SKU_49",b."SKU_50"
       ,b."SKU_51",b."SKU_52",b."SKU_53",b."SKU_54",b."SKU_55",b."SKU_56",b."SKU_57",b."SKU_58",b."SKU_59",b."SKU_60",b."SKU_61",b."SKU_62",b."SKU_63"
       ,b."SKU_64",b."SKU_65",b."SKU_66",b."SKU_67",b."SKU_68",b."SKU_69",b."SKU_70"
)UNPIVOT 
(

sku_id FOR sku_name IN 
(
		 "SKU_1" , "SKU_2" , "SKU_3" , "SKU_4" , "SKU_5" , "SKU_6" , "SKU_7" , "SKU_8" , "SKU_9", "SKU_10", "SKU_11"
       , "SKU_12", "SKU_13", "SKU_14", "SKU_15", "SKU_16", "SKU_17", "SKU_18", "SKU_19", "SKU_20", "SKU_21", "SKU_22", "SKU_23", "SKU_24"
       , "SKU_25", "SKU_26", "SKU_27", "SKU_28", "SKU_29", "SKU_30", "SKU_31", "SKU_32", "SKU_33", "SKU_34", "SKU_35", "SKU_36", "SKU_37"
       , "SKU_38", "SKU_39", "SKU_40", "SKU_41", "SKU_42", "SKU_43", "SKU_44", "SKU_45", "SKU_46", "SKU_47", "SKU_48", "SKU_49", "SKU_50"
       , "SKU_51", "SKU_52", "SKU_53", "SKU_54", "SKU_55", "SKU_56", "SKU_57", "SKU_58", "SKU_59", "SKU_60", "SKU_61", "SKU_62", "SKU_63"
       , "SKU_64", "SKU_65", "SKU_66", "SKU_67", "SKU_68", "SKU_69", "SKU_70"
)
)
WHERE LEFT("year_period_new",4) >= 2020
GROUP BY "year_period_new","Vendor_No","SKU_ID";

<br>
--SHRINK_DEFECTIVE_2020
</br>
insert into "SHRINK_DEFECTIVE_2020"
SELECT  
     TRY_TO_NUMBER("Article")
    ,"Article_Description"
    ,"User_name"
    ,TRY_TO_NUMBER("Movement_type")
    ,"Posting_date"
    ,"Quantity"
    ,"BUOM"
    ,"Amount_in_LC"
    ,"Currency"
    ,"Site"
    ,"Reference"
    ,"Receiving_Issuing_site"
    ,"Entry_Date"
    ,CAST("Storage_Location" AS VARCHAR)
    ,TRY_TO_NUMBER("Purchase_order")
    ,TRY_TO_NUMBER("Vendor")
    ,"Debit_Credit_Indicator"
FROM   "SHRINK_DEFECTIVE"
UNION ALL 
  SELECT 
     "Article"
    ,"Article_Description"
    ,"User_name"
    ,TRY_TO_NUMBER("Movement_type")
    ,"Posting_date"
    ,"Quantity"
    ,"BUOM"
    ,"Amount_in_LC"
    ,"Currency"
    ,"Site"
    ,"Reference"
    ,"Receiving_Issuing_site"
    ,"Entry_Date"
    ,CAST("Storage_Location" AS VARCHAR)
    ,TRY_TO_NUMBER("Purchase_order")
    ,TRY_TO_NUMBER("Vendor")
    ,"Debit_Credit_Indicator"
  FROM   "SHRINK_DEFECTIVE_2021_2022"
  UNION ALL
SELECT
     "Article"
    ,"Article_Description"
    ,"User_name"
    ,"Movement_type"
    ,"Posting_date"
    ,"Quantity"
    ,"BUOM"
    ,"Amount_in_LC"
    ,"Currency"
    ,"Site"
    ,"Reference"
    ,"Receiving_Issuing_site"
    ,"Entry_Date"
    ,CAST("Storage_Location" AS VARCHAR)
    ,TRY_TO_NUMBER("Purchase_order")
    ,"Vendor"
    ,"Debit_Credit_Indicator"
  FROM LM_SHRINK_COMBINED_PREP_STG
  WHERE  "Movement_type" in (991,891,980,880,982,882,995,895)

<br>
--NEW_STORE_DISCOUNT_PREPARED_PREPARED
</br>

INSERT INTO "NEW_STORE_DISCOUNT_PREPARED_PREPARED"
SELECT  "NSD_Sku",
    "Sum_Ordered_Qty",
    "Sum_Received_Qty",
    "Vendor_ID",
    "Sum_NSD_Discount_Amt",
    "Period",
    Ltrim(Replace(LEFT("Period", 2), 'Q', ''))                           AS
    Period_0,
    RIGHT("Period", 4)                                                   AS
    year,
    Concat(RIGHT("Period", 4), Ltrim(Replace(LEFT("Period", 2), 'Q', ''))) AS
    year_quarter
FROM "NEW_STORE_DISCOUNT_PREPARED" 
UNION ALL
SELECT   "NSD_Sku",
    NULL AS Sum_Ordered_Qty,
    NULL AS Sum_Received_Qty,
    "Vendor_Id",
    "NSD_Discount_Amt",
    NULL AS Period,
    NULL AS Period_0,
    "year",
    "Year_Quarter"
FROM  "LM_NEW_STORE_DISCOUNT_20221028_PREP"  
WHERE "Year_Quarter" >= 20223
UNION ALL 
SELECT   "NSD_Sku",
    NULL AS Sum_Ordered_Qty,
    NULL AS Sum_Received_Qty,
    "Vendor_Id",
    "NSD_Discount_Amt",
    NULL AS Period,
    NULL AS Period_0,
    "year",
    REPLACE("Year_Quarter",'20241','20242') AS "Year_Quarter" 
FROM  "LM_NEW_STORE_DISCOUNT_20221028_PREP"    
WHERE "Year_Quarter" ='20241';

<br>
--SHRINK_THEFT_INVENTORY_ACTUAL_SHRINK
</br>
insert into  "SHRINK_THEFT_INVENTORY_ACTUAL_SHRINK"
WITH CTE AS 
(
SELECT   "SKU", 
         CASE
         WHEN "Month" = 'January' THEN '01'
         WHEN "Month" = 'February' THEN '02'
         WHEN "Month" = 'March' THEN '03'
         WHEN "Month" = 'April' THEN '04'
         WHEN "Month" = 'May' THEN '05'
         WHEN "Month" = 'June' THEN '06'
         WHEN "Month" = 'July' THEN '07'
         WHEN "Month" = 'August' THEN '08'
         WHEN "Month" = 'September' THEN '09'
         WHEN "Month" = 'October' THEN '10'
         WHEN "Month" = 'November' THEN '11'
         WHEN "Month" = 'December' THEN '12'
        END AS "Month",
        cast(year as bigint) as year,
        CASE
         WHEN "Month" = 'January' THEN Concat(cast(year as bigint) , '01')
         WHEN "Month" = 'February' THEN Concat(cast(year as bigint), '02')
         WHEN "Month" = 'March' THEN Concat(cast(year as bigint), '03')
         WHEN "Month" = 'April' THEN Concat(cast(year as bigint), '04')
         WHEN "Month" = 'May' THEN Concat(cast(year as bigint), '05')
         WHEN "Month" = 'June' THEN Concat(cast(year as bigint), '06')
         WHEN "Month" = 'July' THEN Concat(cast(year as bigint), '07')
         WHEN "Month" = 'August' THEN Concat(cast(year as bigint), '08')
         WHEN "Month" = 'September' THEN Concat(cast(year as bigint), '09')
         WHEN "Month" = 'October' THEN Concat(cast(year as bigint), '10')
         WHEN "Month" = 'November' THEN Concat(cast(year as bigint), '11')
         WHEN "Month" = 'December' THEN Concat(cast(year as bigint), '12')
       END AS year_period,
       sales,
       cost,
       theft,
       shrink
FROM   (SELECT  "SKU",
               "Month",
               '2020'                       AS year,
               SUM("Theft_Shrink_dol" )     AS Theft,
               SUM("Inventory_Shrink_dol")  AS Shrink,
               SUM("Cost")                  AS Cost,
               SUM("Sales")                 AS Sales
        FROM   "SHRINK_THEFT_INVENTORY_2020_DEC_PREPARED"
        GROUP  BY "SKU",
                  "Month",
                  year
        UNION ALL
        SELECT  "SKU",
               "Month",
               '2021'                 AS year,
               SUM("2021_Theft_dol" ) AS Theft,
               SUM("2021_Shrink_dol") AS Shrink,
               SUM("2021_Cost")      AS Cost,
               SUM("2021_Sales" )     AS Sales
        FROM    "SHRINK_THEFT_INVENTORY_2021_2020_JAN_NOV_PREPARED"
        GROUP  BY  "SKU",
                  "Month",
                  year
        UNION ALL
        SELECT   "SKU",
               "Month",
               '2020'              AS year,
               SUM("2020_Theft_dol") AS Theft,
               SUM("2020_Shrink_dol")AS Shrink,
               SUM("2020_Cost")      AS Cost,
               SUM("2020_Sales")     AS Sales
        FROM    "SHRINK_THEFT_INVENTORY_2021_2020_JAN_NOV_PREPARED"
        GROUP  BY  "SKU",
                  "Month",
                  year
        UNION ALL
        SELECT  "SKU",
               "Month" ,
               '2021'                   AS year,
               SUM("Theft_Shrink_dol")    AS Theft,
               SUM("Inventory_Shrink_dol")AS Shrink,
               SUM("Cost_dol")            AS Cost,
               SUM("Sales_dol")           AS Sales
        FROM    "SHRINK_THEFT_INVENTORY_2021_DEC_PREPARED"
        GROUP  BY "SKU",
                  "Month" ,
                  year
        UNION ALL
        SELECT  "SKU",
               "Month",
               '2022' AS year,
               SUM("2022_Theft_dol") AS Theft,
               SUM("2022_Shrink_dol")AS Shrink,
               SUM("2022_Cost_dol")  AS Cost,
               SUM("2022_Sales_dol") AS Sales               
        FROM   "SHRINK_THEFT_INVENTORY_PREPARED_STACKED" 
        GROUP  BY "SKU",
                  "Month",
                   year
        UNION ALL
        SELECT  "SKU" ,
               "Month",
               "Year",
               SUM("2023 Theft $") AS Theft,
               SUM("2023 Shrink $")AS Shrink,
               SUM("2023 Cost $")  AS Cost,
               SUM("2023 Sales $") AS Sales
        FROM   "LM_INVENTORY_SHRINK_CSV_PREPARED"
        GROUP  BY "SKU" ,
                  "Month",
                   "Year") A)

  SELECT  "SKU",
         "Month",
        "YEAR",
        "YEAR_PERIOD",
       sales,
       cost,
       theft,
       shrink,
       theft_previous,
       COALESCE(theft,0) -COALESCE(theft_previous,0)  AS actual_theft,
       shrink_previous,
       COALESCE(shrink,0)-COALESCE(shrink_previous,0) AS actual_shrink
FROM   (
                SELECT     "SKU",
                          "Month",
                         "YEAR",
                        "YEAR_PERIOD",
                         sales,
                         cost,
                         theft,
                         shrink,
                         lag(theft,1)OVER(partition BY "SKU","YEAR" ORDER BY  "YEAR_PERIOD" ASC)  AS theft_previous ,
                         lag(shrink,1)OVER(partition BY "SKU","YEAR" ORDER BY  "YEAR_PERIOD" ASC) AS shrink_previous
                FROM     (
                            SELECT         "SKU",
                                           "Month",
                                            "YEAR",
                                           "YEAR_PERIOD",
                                           sum("SALES")  AS sales,
                                           sum("COST")   AS cost,
                                           sum("THEFT")  AS theft,
                                           sum("SHRINK") AS shrink
                                  FROM    CTE
                                  GROUP BY "SKU",
                                           "Month",
                                           "YEAR",
                                           "YEAR_PERIOD"  )A WHERE "YEAR" >=2020 )Final_;

<br>
--THEFT_V2_PREPARED_STACKED
</br>
INSERT INTO "THEFT_V2_PREPARED_STACKED"
 SELECT
     "Article"
    ,"Article_Description"
    ,"User_name"
    ,"Movement_type"
    ,"Posting_date"
    ,"Quantity"
    ,"BUOM"
    ,"Amount_in_LC"
    ,"Currency"
    ,"Site"
    ,"Reference"
    ,"Receiving_Issuing_site"
    ,"Entry_Date"
    ,CAST("Storage_Location" AS VARCHAR)
    ,TRY_TO_NUMBER("Purchase_order")
    ,"Vendor"
    ,"Debit_Credit_Indicator"
  FROM LM_SHRINK_COMBINED_PREP_STG
  WHERE    "Movement_type" = 876 OR "Movement_type" = 976
UNION ALL
SELECT  "Article" AS "Article",
        "Article_Description" AS "Article_Description",
        "User_name" AS "User_name",
        "Movement_type" AS "Movement_type",
        "Posting_date" AS "Posting_date",
        "Quantity" AS "Quantity",
        "BUOM" AS "BUOM",
        "Amount_in_LC" AS "Amount_in_LC",
        "Currency" AS "Currency",
        "Site" AS "Site",
        "Reference" AS "Reference",
        "Receiving_Issuing_site" AS "Receiving_Issuing_site",
        "Entry_Date" AS "Entry_Date",
        "Storage_Location" AS "Storage_Location",
        "Purchase_order" AS "Purchase_order",
        "Vendor" AS "Vendor",
        "Debit_Credit_Indicator" AS "Debit_Credit_Indicator"
FROM  "THEFT_V2_PREPARED";

<br>
--UNSELLABLES_AND_MISC_STACKED
</br>

INSERT INTO "UNSELLABLES_AND_MISC_STACKED"
SELECT
     "Article"
    ,"Article_Description"
    ,"User_name"
    ,"Movement_type"
    ,"Posting_date"
    ,"Quantity"
    ,"BUOM"
    ,"Amount_in_LC"
    ,"Currency"
    ,"Site"
    ,"Reference"
    ,"Receiving_Issuing_site"
    ,"Entry_Date"
    ,CAST("Storage_Location" AS VARCHAR)
    ,TRY_TO_NUMBER("Purchase_order")
    ,"Vendor"
    ,"Debit_Credit_Indicator"
  FROM LM_SHRINK_COMBINED_PREP_STG
       WHERE      "Movement_type" = 977
                  OR "Movement_type" = 877
                  OR "Movement_type" = 983
                  OR "Movement_type" = 883
                  OR "Movement_type" = 978
                  OR "Movement_type" = 878
UNION ALL
SELECT          "Article",
               "Article_Description",
               "User_name",
               "Movement_type",	
               "Posting_date",
               "Quantity",
               "BUOM",
               "Amount_in_LC",
               "Currency",
               "Site",
               "Reference",
               "Receiving_Issuing site" AS Receiving_Issuingsite,
               "Entry_Date",
               "Storage_Location",
               TRY_TO_NUMBER("Purchase_order"),
               "Vendor",
               "Debit_Credit_Indicator"
FROM "UNSELLABLES_AND_MISC_PREPARED" ;

<br>
--OMNI_LM_MULTICHANNEL_SALVAGE_STACKED
</br>
insert into  "OMNI_LM_MULTICHANNEL_SALVAGE_STACKED"
SELECT        "Article",
               "Article_Description",
               "User_name",
               "Movement_type",
               "Posting_date",
               "Quantity",
               "BUOM",
               "Amount_in_LC",
               "Currency",
               "Site",
               "Reference",
               "Receiving_Issuing_site",
               "Entry_Date",
               "Storage_Location",
               "Purchase_order",
               "Vendor",
               "Debit_Credit_Indicator"
FROM   (SELECT  "Article",
               "Article_Description",
               "User_name",
               "Movement_type",
               "Posting_date",
               "Quantity",
               "BUOM",
               "Amount_in_LC",
               "Currency",
               "Site",
               "Reference",
               "Receiving_Issuing_site",
               "Entry_Date",
               "Storage_Location",
               "Purchase_order",
               "Vendor",
               "Debit_Credit_Indicator"
        FROM   LM_SHRINK_COMBINED_PREP_STG) A
        WHERE  ( "Movement_type" = 985
          OR "Movement_type" = 885 )
UNION ALL
SELECT   "Article",
               "Article_Description",
               "User_name",
               "Movement_type",
               "Posting_date",
               "Quantity",
               "BUOM",
               "Amount_in_LC",
               "Currency",
               "Site",
               "Reference",
               "Receiving_Issuing site" AS "Receiving_Issuing_site",
               "Entry_Date",
               "Storage_Location",
               "Purchase_order",
               "Vendor",
               "Debit_Credit_Indicator"
FROM   "UNSELLABLES_AND_MISC_PREPARED"
WHERE  ( "Movement_type" = 985
          OR "Movement_type" = 885 ) ;
		  
<br>		  
--TLM_SHIPMENT_ACTUAL_DELIVERY_DATE
</br>
insert into "TLM_SHIPMENT_ACTUAL_DELIVERY_DATE"
SELECT            "SHIPMENT_NUMBER",
                          "DB_SHIPMENT_ID",
                          "ORIGIN",
                          "FINAL_DESTINATION" ,
                           "PLANNED_DELIVERY_DATE",
                           "ACTUAL_DELIVERY_DATE",
                           To_date("ACTUAL_DELIVERY_DATE") AS "ACTUAL_DELIVERY",
                           TO_TIMESTAMP(TRY_TO_DATE(ACTUAL_DELIVERY_DATE)) AS "ACTUAL_DELIVERY_DATE_PARSED"
FROM  (
                SELECT   "SHIPMENT_NUMBER",
                          "DB_SHIPMENT_ID",
                         "ORIGIN",
                          "FINAL_DESTINATION" ,
                         min("PLANNED_DELIVERY_DATE") AS "PLANNED_DELIVERY_DATE",
                         max(  "ACTUAL_DELIVERY_DATE")  AS "ACTUAL_DELIVERY_DATE"
                FROM     (
                                  SELECT   "SHIPMENT_NUMBER",
                                           "DB_SHIPMENT_ID",
                                           "ORIGIN",
                                           "FINAL_DESTINATION",
                                           "PLANNED_DELIVERY_DATE",
                                           "ACTUAL_DELIVERY_DATE" 
                                  FROM     "TLM_SHIPMENT_ACTUAL_DELIVERY_DISTINCT" )A
                GROUP BY  "SHIPMENT_NUMBER",
                          "DB_SHIPMENT_ID",
                         "ORIGIN",
                          "FINAL_DESTINATION"  )A;
						  
<br>					  
--DC_3PL_LOCATION_MAPPING_PREPARED
</br>
insert into "DC_3PL_LOCATION_MAPPING_PREPARED"
SELECT 
    "Facility_Code",
    "Facility",
    "DC Hierchy" AS "DC_Hierchy",
    "DC/3PL"
FROM 
(
SELECT 
    "Facility_Code",
    "Facility",
    "DC Hierchy",
    TRIM("DC/3PL") AS "DC/3PL",
    ROW_NUMBER() OVER (PARTITION BY "Facility_Code" ORDER BY "Facility" ASC NULLS FIRST) AS "rownumber"
FROM
"DC_3PL_LOCATION_MAPPING_STACKED"
    )WHERE ("rownumber" = 1) AND ((CAST("Facility_Code" AS VARCHAR) != '' OR CAST("Facility_Code" AS VARCHAR) IS NULL AND '' IS NOT NULL OR CAST("Facility_Code" AS VARCHAR) IS NOT NULL AND '' IS NULL) AND "Facility_Code" IS NOT NULL)
    AND ("Facility_Code" IS NOT NULL OR "Facility_Code" ='' ) 
    ORDER BY "Facility_Code"  ASC;

<br>
--DC_3PL_PNL_OMNI_FULFILLMENT_BY_COST_CENTER
</br>
insert into  "DC_3PL_PNL_OMNI_FULFILLMENT_BY_COST_CENTER"
 SELECT      "Cost Center" AS "Cost Center",
            "Year" AS "Year",
            "Period" AS "Period",
            "Cost_Type" AS "Cost_Type",
            SUM("Actual") AS "Actual_sum"
FROM 
(
  SELECT 
        "Cost Center" AS "Cost Center",
        "Cost Type" AS "Cost Type",
        "Year" AS "Year",
        "Period" AS "Period",
        "Actual" AS "Actual",
        CASE WHEN "Cost Type" LIKE CONCAT('%', IFNULL(TO_VARCHAR(REPLACE(REPLACE(REPLACE('Fixed', '\\', '\\\\'), '%', '\\%'), '_', '\\_')), ''), '%') 
             ESCAPE '\\' THEN 'Fixed' ELSE 'Variable' END AS "Cost_Type"
 FROM 
(
 SELECT   
        "Cost Center" AS "Cost Center",
        "Cost Type" AS "Cost Type",
        "Year" AS "Year",
        "Period" AS "Period",
        SUM("Actual") AS "Actual"
FROM  "DC_3PL_PANDL_PREPARED"
GROUP BY "Cost Center","Cost Type","Year","Period"
UNION ALL 

SELECT    
        "Cost_Center" AS "Cost_Center",
        "Cost_Type" AS "Cost_Type",
        "Year" AS "Year",
        "Period" AS "Period",
        SUM("Actual") AS "Actual"
FROM "DC_3PL_FIXED_VARIABLE_PL_YEAR_END_2022_THRU_11422_PREPARED"
GROUP BY "Cost_Type", "Cost_Center","Year","Period"

UNION ALL 
SELECT   
         "Cost Center" AS "Cost Center",
        "Cost_Type" AS "Cost_Type",
        "Year" AS "Year",
        "Period" AS "Period",
        SUM("Actual") AS "Actual"
FROM 
(
SELECT   
    "A"."Sort_P&L_Section" AS "Sort P&L Section",
    "A"."Sort_P&L_Rollup" AS "Sort P&L Rollup",
    "A"."P&L_Section" AS "P&L Section",
    "A"."P&L_Roll_Up" AS "P&L Roll Up",
    "A"."Account_Name" AS "Account Name",
    "A"."Account_Number" AS "Account Number",
    "A"."Cost_Center" AS "Cost Center",
    "A"."Cost_Center_Name" AS "Cost Center Name",
    "A"."Region" AS "Region",
    "A"."District" AS "District",
    "A"."Year" AS "Year",
    "A"."Quarter" AS "Quarter",
    "A"."Period" AS "Period",
    "A"."Actual" AS "Actual",
    "A"."Plan" AS "Plan",
    "A"."Var_Plan" AS "Var Plan",
    "A"."Prior_Year" AS "Prior Year",
    "A"."Var_PY" AS "Var PY",
    "B"."Cost_Type" AS "Cost_Type",
    CASE WHEN   A."Account_Number"=72706 THEN 'Fixed labor'
	     WHEN   A."Account_Number"=90506 THEN 'Variable supplies' ELSE B."Cost_Type" END AS "CostType"
  FROM "DC3PL_PNL_PREPARED_STACKED" "A"
  LEFT JOIN (
                 SELECT 
                        "Cost_Type" AS "Cost_Type",
                        "Account_Number" AS "Account_Number"
                 FROM  "DC_3PL_FIXED_VARIABLE_PL_YEAR_END_2022_THRU_11422_PREPARED" 
                 WHERE (CAST("Cost_Type" AS VARCHAR) != '' OR CAST("Cost_Type" AS VARCHAR) IS NULL AND '' IS NOT NULL OR CAST("Cost_Type" AS                                    VARCHAR) IS NOT NULL AND '' IS NULL) AND "Cost_Type" IS NOT NULL AND ("Cost_Type" != 'Exclude' OR "Cost_Type" IS NULL AND                             'Exclude' IS NOT NULL OR "Cost_Type" IS NOT NULL AND 'Exclude' IS NULL) AND "Account_Number" IS NOT NULL
                 GROUP BY "Cost_Type", "Account_Number"
            )B
    ON "A"."Account_Number" = "B"."Account_Number"
)A
GROUP BY "Cost_Type","Cost Center","Year","Period"
)A
WHERE ("Cost Center" = 108) OR ("Cost Center" = 141) OR ("Cost Center" = 149) OR ("Cost Center" = 168) OR ("Cost Center" = 188) OR ("Cost Center" = 208) OR ("Cost Center" = 233) OR ("Cost Center" = 598) OR ("Cost Center" = 609)
) FINAL 
WHERE "Year" >= 2020
GROUP BY "Cost Center", "Year", "Period", "Cost_Type";

<br>
--INVENTORYDETAIL
</br>

INSERT INTO INVENTORYDETAIL
select 
   article_no, 
   article_length, 
   article_width, 
   article_height, 
   article_weight, 
   article_volume, 
   upc, 
   cubiscan_last_updated_dttm
from
(select article_no, article_length, article_width, article_height, article_weight, article_volume, upc
from
(select item_name article_no, unit_length article_length, unit_width article_width, unit_height article_height, unit_weight article_weight,  unit_volume article_volume, item_bar_code upc, cubiscan_last_updated_dttm, cdc_timestamp,  row_number() over (Partition by item_name ORDER by cdc_timestamp desc) as last_updated
from EDW.VW_sc_wms_item_cbo ic
join
(select  to_char(article_no) sku from EDW.VW_article_unit_of_measure where primary_uom_flag = 'Y') item on ic.item_name = item.sku
where ic.store_no = 111)
where last_updated = 1) mq
left join
(select item_name, cubiscan_last_updated_dttm
from
(select item_name , unit_length article_length, unit_width article_width, unit_height article_height, unit_weight article_weight,  unit_volume article_volume, item_bar_code upc, cubiscan_last_updated_dttm, cdc_timestamp,  row_number() over (Partition by item_name ORDER by cubiscan_last_updated_dttm desc nulls last) as last_updated
from EDW.VW_sc_wms_item_cbo ic
join
(select  to_char(article_no) sku from EDW.VW_article_unit_of_measure where primary_uom_flag = 'Y') item on ic.item_name = item.sku
where ic.store_no = 111)
where last_updated = 1 and cubiscan_last_updated_dttm is not null) cs on mq.article_no = cs.item_name

<br>
--ARTICLE_W_SHP_DIM_PREP
</br>

INSERT INTO ARTICLE_W_SHP_DIM_PREP
SELECT 
        CHAIN_PROD,
        ARTICLE_NO,
        ARTICLE_EFF_DATE,
        ARTICLE_UPD_TS,
        ARTICLE_DIM_KEY,
        ARTICLE_DESC,
        ARTICLE_FULL,
        ARTICLE_TYPE_NAME,
        ARTICLE_TYPE_CODE,
        ARTICLE_TYPE_FULL,
        LABEL_TYPE_CODE,
        UOM_CODE,
        UOM_DESC,
        UOM_FULL,
        PLANOGRAM_NO,
        PLANOGRAM_FACE,
        PLANOGRAM_SEQ,
        ARTICLE_CREATE_DATE,
        ACCT_POOL_CODE,
        coalesce(shp_ARTICLE_LENGTH,ARTICLE_LENGTH) as ARTICLE_LENGTH,
        coalesce(shp_ARTICLE_WIDTH,ARTICLE_WIDTH) as ARTICLE_WIDTH,
        coalesce(shp_ARTICLE_HEIGHT,ARTICLE_HEIGHT) as ARTICLE_HEIGHT,
        coalesce(shp_ARTICLE_WEIGHT,ARTICLE_WEIGHT) as ARTICLE_WEIGHT,
        ARTICLE_SIZE,
        ARTICLE_COUNT,
        ARTICLE_COLOR,
        LOC_TYPE_CODE,
        WORKSHEET_CYCLE,
        PARENT_ARTICLE_NO,
        PARENT_ARTICLE_DESC,
        PARENT_ARTICLE_FULL,
        POG_CAT_STRATEGY,
        POG_KPI_WT_SALES,
        POG_KPI_WT_PROFIT,
        POG_KPI_WT_UNIT_MV,
        PRIMARY_VENDOR_ID,
        ARTICLE_WTY_START_DATE,
        SPACE_PLANNER_NO,
        ARTICLE_CAT_CODE,
        ARTICLE_CAT_NAME,
        ARTICLE_CAT_FULL,
        DEPT_CODE,
        DEPT_NAME,
        DEPT_FULL,
        LOB_NO,
        LOB_DESC,
        LOB_FULL,
        MAJ_DEPT_NO,
        MAJ_DEPT_DESC,
        MAJ_DEPT_FULL,
        DISPLAY_ARTICLE_FLAG,
        SEASON_DESC,
        ARTICLE_THEME_DESC,
        BRAND_NAME,
        PVT_LABEL_DESC,
        ARTICLE_FREIGHT_START_DATE,
        ARTICLE_FREIGHT_AMT,
        UPC,
        HTS_CODE,
        ADDL_HTS_CODE_1,
        ADDL_HTS_CODE_2,
        ARTICLE_UOM_FACTOR_NUMERATOR,
        ARTICLE_UOM_FACTOR_DENOMINATOR,
        ADDL_ARTICLE_NO,
        ARTICLE_40HC_QTY,
        ARTICLE_40GP_QTY,
        ARTICLE_MIN_ADV_PRICE,
        OLD_ARTICLE_NO,
        ARTICLE_EDW_ID,
        ARTICLE_EDW_ACTV_FLAG,
        ARTICLE_REPLACEMENT_TYPE,
        ARTICLE_REPLACEMENT_FLAG,
        ARTICLE_ADD_ON_CAT,
        MANUFACTURER_VENDOR_NAME,
        ARTICLE_PETSENSE_LOYALTY_ELIG_FLAG,
        ARTICLE_WEB_EXCLUSION_FLAG,
        ARTICLE_WEB_INFO_FLAG,
        ARTICLE_BOPIS_ELIG_FLAG,
        ARTICLE_HAZMAT_FLAG,
        ARTICLE_WARRANTY_ELIG_FLAG,
        ARTICLE_BODFS_STD_ELIG_FLAG,
        ARTICLE_BODFS_PREMIUM_ELIG_FLAG,
        ARTICLE_BODFS_SAME_DAY_ELIG_FLAG,
        ARTICLE_SUBS_BOPIS_ELIG_FLAG,
        ARTICLE_SUBS_S2H_ELIG_FLAG,
        ARTICLE_ASSEMBLY_ELIG_FLAG,
        ARTICLE_SFS_ELIG_FLAG,
        ARTICLE_SUB_GROUP,
        SHP_ARTICLE_LENGTH,
       SHP_ARTICLE_WIDTH,
       SHP_ARTICLE_HEIGHT,
       SHP_ARTICLE_WEIGHT
  FROM(
SELECT 
    article.CHAIN_PROD AS CHAIN_PROD,
    article.ARTICLE_NO AS ARTICLE_NO,
    article.ARTICLE_EFF_DATE AS ARTICLE_EFF_DATE,
    article.ARTICLE_UPD_TS AS ARTICLE_UPD_TS,
    article.ARTICLE_DIM_KEY AS ARTICLE_DIM_KEY,
    article.ARTICLE_DESC AS ARTICLE_DESC,
    article.ARTICLE_FULL AS ARTICLE_FULL,
    article.ARTICLE_TYPE_NAME AS ARTICLE_TYPE_NAME,
    article.ARTICLE_TYPE_CODE AS ARTICLE_TYPE_CODE,
    article.ARTICLE_TYPE_FULL AS ARTICLE_TYPE_FULL,
    article.LABEL_TYPE_CODE AS LABEL_TYPE_CODE,
    article.UOM_CODE AS UOM_CODE,
    article.UOM_DESC AS UOM_DESC,
    article.UOM_FULL AS UOM_FULL,
    article.PLANOGRAM_NO AS PLANOGRAM_NO,
    article.PLANOGRAM_FACE AS PLANOGRAM_FACE,
    article.PLANOGRAM_SEQ AS PLANOGRAM_SEQ,
    article.ARTICLE_CREATE_DATE AS ARTICLE_CREATE_DATE,
    article.ACCT_POOL_CODE AS ACCT_POOL_CODE,
    article.ARTICLE_LENGTH AS ARTICLE_LENGTH,
    article.ARTICLE_WIDTH AS ARTICLE_WIDTH,
    article.ARTICLE_HEIGHT AS ARTICLE_HEIGHT,
    article.ARTICLE_WEIGHT AS ARTICLE_WEIGHT,
    article.ARTICLE_SIZE AS ARTICLE_SIZE,
    article.ARTICLE_COUNT AS ARTICLE_COUNT,
    article.ARTICLE_COLOR AS ARTICLE_COLOR,
    article.LOC_TYPE_CODE AS LOC_TYPE_CODE,
    article.WORKSHEET_CYCLE AS WORKSHEET_CYCLE,
    article.PARENT_ARTICLE_NO AS PARENT_ARTICLE_NO,
    article.PARENT_ARTICLE_DESC AS PARENT_ARTICLE_DESC,
    article.PARENT_ARTICLE_FULL AS PARENT_ARTICLE_FULL,
    article.POG_CAT_STRATEGY AS POG_CAT_STRATEGY,
    article.POG_KPI_WT_SALES AS POG_KPI_WT_SALES,
    article.POG_KPI_WT_PROFIT AS POG_KPI_WT_PROFIT,
    article.POG_KPI_WT_UNIT_MV AS POG_KPI_WT_UNIT_MV,
    article.PRIMARY_VENDOR_ID AS PRIMARY_VENDOR_ID,
    article.ARTICLE_WTY_START_DATE AS ARTICLE_WTY_START_DATE,
    article.SPACE_PLANNER_NO AS SPACE_PLANNER_NO,
    article.ARTICLE_CAT_CODE AS ARTICLE_CAT_CODE,
    article.ARTICLE_CAT_NAME AS ARTICLE_CAT_NAME,
    article.ARTICLE_CAT_FULL AS ARTICLE_CAT_FULL,
    article.DEPT_CODE AS DEPT_CODE,
    article.DEPT_NAME AS DEPT_NAME,
    article.DEPT_FULL AS DEPT_FULL,
    article.LOB_NO AS LOB_NO,
    article.LOB_DESC AS LOB_DESC,
    article.LOB_FULL AS LOB_FULL,
    article.MAJ_DEPT_NO AS MAJ_DEPT_NO,
    article.MAJ_DEPT_DESC AS MAJ_DEPT_DESC,
    article.MAJ_DEPT_FULL AS MAJ_DEPT_FULL,
    article.DISPLAY_ARTICLE_FLAG AS DISPLAY_ARTICLE_FLAG,
    article.SEASON_DESC AS SEASON_DESC,
    article.ARTICLE_THEME_DESC AS ARTICLE_THEME_DESC,
    article.BRAND_NAME AS BRAND_NAME,
    article.PVT_LABEL_DESC AS PVT_LABEL_DESC,
    article.ARTICLE_FREIGHT_START_DATE AS ARTICLE_FREIGHT_START_DATE,
    article.ARTICLE_FREIGHT_AMT AS ARTICLE_FREIGHT_AMT,
    article.UPC AS UPC,
    article.HTS_CODE AS HTS_CODE,
    article.ADDL_HTS_CODE_1 AS ADDL_HTS_CODE_1,
    article.ADDL_HTS_CODE_2 AS ADDL_HTS_CODE_2,
    article.ARTICLE_UOM_FACTOR_NUMERATOR AS ARTICLE_UOM_FACTOR_NUMERATOR,
    article.ARTICLE_UOM_FACTOR_DENOMINATOR AS ARTICLE_UOM_FACTOR_DENOMINATOR,
    article.ADDL_ARTICLE_NO AS ADDL_ARTICLE_NO,
    article.ARTICLE_40HC_QTY AS ARTICLE_40HC_QTY,
    article.ARTICLE_40GP_QTY AS ARTICLE_40GP_QTY,
    article.ARTICLE_MIN_ADV_PRICE AS ARTICLE_MIN_ADV_PRICE,
    article.OLD_ARTICLE_NO AS OLD_ARTICLE_NO,
    article.ARTICLE_EDW_ID AS ARTICLE_EDW_ID,
    article.ARTICLE_EDW_ACTV_FLAG AS ARTICLE_EDW_ACTV_FLAG,
    article.ARTICLE_REPLACEMENT_TYPE AS ARTICLE_REPLACEMENT_TYPE,
    article.ARTICLE_REPLACEMENT_FLAG AS ARTICLE_REPLACEMENT_FLAG,
    article.ARTICLE_ADD_ON_CAT AS ARTICLE_ADD_ON_CAT,
    article.MANUFACTURER_VENDOR_NAME AS MANUFACTURER_VENDOR_NAME,
    article.ARTICLE_PETSENSE_LOYALTY_ELIG_FLAG AS ARTICLE_PETSENSE_LOYALTY_ELIG_FLAG,
    article.ARTICLE_WEB_EXCLUSION_FLAG AS ARTICLE_WEB_EXCLUSION_FLAG,
    article.ARTICLE_WEB_INFO_FLAG AS ARTICLE_WEB_INFO_FLAG,
    article.ARTICLE_BOPIS_ELIG_FLAG AS ARTICLE_BOPIS_ELIG_FLAG,
    article.ARTICLE_HAZMAT_FLAG AS ARTICLE_HAZMAT_FLAG,
    article.ARTICLE_WARRANTY_ELIG_FLAG AS ARTICLE_WARRANTY_ELIG_FLAG,
    article.ARTICLE_BODFS_STD_ELIG_FLAG AS ARTICLE_BODFS_STD_ELIG_FLAG,
    article.ARTICLE_BODFS_PREMIUM_ELIG_FLAG AS ARTICLE_BODFS_PREMIUM_ELIG_FLAG,
    article.ARTICLE_BODFS_SAME_DAY_ELIG_FLAG AS ARTICLE_BODFS_SAME_DAY_ELIG_FLAG,
    article.ARTICLE_SUBS_BOPIS_ELIG_FLAG AS ARTICLE_SUBS_BOPIS_ELIG_FLAG,
    article.ARTICLE_SUBS_S2H_ELIG_FLAG AS ARTICLE_SUBS_S2H_ELIG_FLAG,
    article.ARTICLE_ASSEMBLY_ELIG_FLAG AS ARTICLE_ASSEMBLY_ELIG_FLAG,
    article.ARTICLE_SFS_ELIG_FLAG AS ARTICLE_SFS_ELIG_FLAG,
    article.ARTICLE_SUB_GROUP AS ARTICLE_SUB_GROUP,
    InventoryDetail.ARTICLE_LENGTH AS shp_ARTICLE_LENGTH,
    InventoryDetail.ARTICLE_WIDTH AS shp_ARTICLE_WIDTH,
    InventoryDetail.ARTICLE_HEIGHT AS shp_ARTICLE_HEIGHT,
    InventoryDetail.ARTICLE_WEIGHT AS shp_ARTICLE_WEIGHT
  FROM edw.VW_ARTICLE article
  LEFT JOIN INVENTORYDETAIL InventoryDetail
    ON article.ARTICLE_NO = InventoryDetail.ARTICLE_NO) DKU; 

<br>
--FREIGHTDETAIL_PREPARED_JOINED
</br>
insert into
    "FREIGHTDETAIL_PREPARED_JOINED"
SELECT  
    f."ORDER_DATE" AS "ORDER_DATE",
    f."ORDER_NO" AS "ORDER_NO",
    f."PO_ORDER_NO" AS "PO_ORDER_NO",
    f."ORDER_LINE_KEY" AS "ORDER_LINE_KEY",
    f."PO_ORDER_LINE_KEY" AS "PO_ORDER_LINE_KEY",
    f."OMS_ITEM_PARCEL_SHIP_FLAG" AS "OMS_ITEM_PARCEL_SHIP_FLAG",
    f."OMS_ITEM_ID" AS "OMS_ITEM_ID",
    f."OMS_SHIPMENT_LINE_ITEM_DESC" AS "OMS_SHIPMENT_LINE_ITEM_DESC",
    f."TRACKING_NO" AS "TRACKING_NO",
    f."OMS_SHIP_NODE_KEY" AS "OMS_SHIP_NODE_KEY",
    f."SHIPMENT_QTY" AS "SHIPMENT_QTY",
    f."LINE_WEIGHT" AS "LINE_WEIGHT",
    f."SCAC" AS "SCAC",
    f."TRANS_AMT" AS "TRANS_AMT",
    o."OMS_ITEM_WEIGHT" AS "oms_ARTICLE_WEIGHT",
    o."OMS_ITEM_HEIGHT" AS "oms_ARTICLE_HEIGHT",
    o."OMS_ITEM_LENGTH" AS "oms_ARTICLE_LENGTH",
    o."OMS_ITEM_WIDTH" AS "oms_ARTICLE_WIDTH",
   a."ARTICLE_LENGTH" AS "art_ARTICLE_LENGTH",
   a."ARTICLE_WIDTH" AS "art_ARTICLE_WIDTH",
   a."ARTICLE_HEIGHT" AS "art_ARTICLE_HEIGHT",
   a."ARTICLE_WEIGHT" AS "art_ARTICLE_WEIGHT"
   FROM (
   WITH scl AS (
  SELECT DISTINCT
    td.YEAR_PERIOD, 
    CAST(sl.OMS_CREATE_TS AS DATE) AS SHIP_DATE, 
    sl.OMS_SHIPMENT_KEY, 
    sl.OMS_ORDER_LINE_KEY, 
    sl.OMS_ORDER_NO, 
    sl.OMS_ITEM_ID, 
    sl.OMS_SHIPMENT_LINE_ITEM_DESC, 
    NULLIF(s.SCAC, ' ') AS OMS_SCAC, 
    NULLIF(s.SHIPMENT_NO, ' ') AS OMS_SHIPMENT_NO, 
    sl.OMS_SHIPMENT_LINE_KEY, 
    sc.OMS_SHIPMENT_CONTAINER_TRACKING_NO, 
    i.OMS_ITEM_WEIGHT, 
    i.OMS_ITEM_CAT_CODE, 
    sl.OMS_SHIPMENT_LINE_QTY, 
    NULLIF(s.SHIPNODE_KEY, ' ') AS OMS_SHIP_NODE_KEY 
  FROM 
    EDW.OMS_SHIPMENT_LINE sl 
    INNER JOIN EDW.TIME_DIMENSION td ON td.CAL_DATE = CAST(sl.OMS_CREATE_TS  AS DATE) 
    INNER JOIN STG_REPL_OMS.YFS_SHIPMENT s ON s.SHIPMENT_KEY = sl.OMS_SHIPMENT_KEY 
    INNER JOIN EDW.OMS_SHIPMENT_CONTAINER sc ON sc.OMS_SHIPMENT_KEY = s.SHIPMENT_KEY 
    LEFT OUTER JOIN EDW.OMS_ITEM i ON sl.OMS_ITEM_ID = i.OMS_ITEM_ID 
    AND i.OMS_ITEM_ACTV_FLAG = 'Y'
) 
SELECT 
  CAST(oh1.CREATETS AS DATE) AS ORDER_DATE, 
  CASE WHEN NULLIF(oh2.ORDER_NO, ' ') IS NULL THEN scl.OMS_ORDER_NO ELSE NULLIF(oh2.ORDER_NO, ' ') END AS ORDER_NO, 
  CASE WHEN NULLIF(oh2.ORDER_NO, ' ') IS NOT NULL THEN scl.OMS_ORDER_NO ELSE NULL END AS PO_ORDER_NO, 
  TRIM(CASE WHEN ol2.ORDER_LINE_KEY IS NULL THEN scl.OMS_ORDER_LINE_KEY ELSE ol2.ORDER_LINE_KEY END) AS ORDER_LINE_KEY, 
  CASE WHEN ol2.ORDER_LINE_KEY IS NOT NULL THEN ol2.ORDER_LINE_KEY ELSE NULL END AS PO_ORDER_LINE_KEY, 
  i.OMS_ITEM_PARCEL_SHIP_FLAG, 
  scl.OMS_ITEM_ID, 
  scl.OMS_SHIPMENT_LINE_ITEM_DESC, 
  scl.OMS_SHIPMENT_CONTAINER_TRACKING_NO AS TRACKING_NO, 
  scl.OMS_SHIP_NODE_KEY, 
  scl.OMS_SHIPMENT_LINE_QTY AS SHIPMENT_QTY, 
  ROUND(
    SUM(scl.OMS_ITEM_WEIGHT), 
    0
  ) AS LINE_WEIGHT, 
  CASE WHEN fsi.SC_FDX_NET_CHARGE_AMT IS NOT NULL THEN 'FEDX' WHEN UPS.SC_UPS_NET_AMT IS NOT NULL THEN 'UPS' WHEN slc.NET_REVENUE_AMT IS NOT NULL THEN 'CNWY' ELSE NULL END AS SCAC, 
  CASE WHEN UPS.SC_UPS_NET_AMT IS NOT NULL THEN UPS.SC_UPS_NET_AMT WHEN fsi.SC_FDX_NET_CHARGE_AMT IS NOT NULL THEN fsi.SC_FDX_NET_CHARGE_AMT WHEN ssc.NET_TRANS_AMT IS NOT NULL THEN 
  ssc.NET_TRANS_AMT WHEN slc.NET_REVENUE_AMT IS NOT NULL THEN slc.NET_REVENUE_AMT  ELSE NULL  END AS TRANS_AMT 
  FROM 
  scl 
  LEFT OUTER JOIN STG_REPL_OMS.YFS_ORDER_HEADER oh1 ON scl.OMS_ORDER_NO = NULLIF(oh1.ORDER_NO, ' ') 
  LEFT OUTER JOIN STG_REPL_OMS.YFS_ORDER_LINE ol1 ON scl.OMS_ORDER_LINE_KEY = ol1.ORDER_LINE_KEY 
  LEFT OUTER JOIN STG_REPL_OMS.YFS_ORDER_HEADER oh2 ON ol1.CHAINED_FROM_ORDER_HEADER_KEY = oh2.ORDER_HEADER_KEY 
  LEFT OUTER JOIN STG_REPL_OMS.YFS_ORDER_LINE ol2 ON ol1.CHAINED_FROM_ORDER_LINE_KEY = ol2.ORDER_LINE_KEY 
  LEFT OUTER JOIN STG_REPL_OMS.YFS_CONTAINER_DETAILS cd ON scl.OMS_ORDER_LINE_KEY = cd.ORDER_LINE_KEY 
  INNER JOIN (
    SELECT DISTINCT
      OMS_SHIPMENT_CONTAINER_TRACKING_NO, 
      COUNT(OMS_ITEM_ID) AS ITEM_COUNT 
    FROM 
      scl 
    GROUP BY 
      1
  ) sc ON sc.OMS_SHIPMENT_CONTAINER_TRACKING_NO = scl.OMS_SHIPMENT_CONTAINER_TRACKING_NO 
  LEFT OUTER JOIN (
    SELECT DISTINCT
      CONTAINER_TRACKING_NO, 
      SUM(NET_TRANS_AMT) AS NET_TRANS_AMT 
    FROM 
      EDW.VW_SHIPMENT_SMALL_CONTAINER 
    GROUP BY 
      1
  ) ssc ON scl.OMS_SHIPMENT_CONTAINER_TRACKING_NO = ssc.CONTAINER_TRACKING_NO 
  LEFT OUTER JOIN EDW.SC_FDX_SHIPMENT_INVOICE fsi ON scl.OMS_SHIPMENT_CONTAINER_TRACKING_NO = fsi.SC_FDX_EXPRESS_OR_GROUND_TRACKING_ID 
  LEFT JOIN(SELECT DISTINCT  SUM(SC_UPS_NET_AMT)SC_UPS_NET_AMT, SC_UPS_TRACKING_NO FROM EDW.VW_SC_UPS_INVOICE GROUP BY SC_UPS_TRACKING_NO ) UPS 
                                                  ON UPS.SC_UPS_TRACKING_NO =scl.OMS_SHIPMENT_CONTAINER_TRACKING_NO
  LEFT OUTER JOIN EDW.SHIPMENT_LTL_CONTAINER slc ON scl.OMS_SHIPMENT_CONTAINER_TRACKING_NO = slc.PRO_NO 
  LEFT OUTER JOIN EDW.OMS_ITEM i ON scl.OMS_ITEM_ID = i.OMS_ITEM_ID 
  AND i.OMS_ITEM_ACTV_FLAG = 'Y' 
WHERE 
  scl.OMS_ORDER_NO NOT BETWEEN 6000000000 
  AND 6999999999
GROUP BY 
  1, 
  6, 
  7, 
  8, 
  9, 
  10, 
  11, 
  13, 
  14, 
  scl.OMS_ORDER_NO, 
  NULLIF(oh2.ORDER_NO, ' '), 
  scl.OMS_ORDER_LINE_KEY, 
  ol2.ORDER_LINE_KEY )f
                         LEFT JOIN( SELECT  DISTINCT oms_item_id,"OMS_ITEM_WEIGHT","OMS_ITEM_HEIGHT","OMS_ITEM_LENGTH","OMS_ITEM_WIDTH" 
                                    FROM  OMS_ITEM_PREPARED_BY_OMS_ITEM_ID) o
                          ON f.oms_item_id = o.oms_item_id
                         LEFT JOIN (SELECT DISTINCT article_no,"ARTICLE_LENGTH","ARTICLE_WIDTH","ARTICLE_HEIGHT","ARTICLE_WEIGHT"
                                    FROM  ARTICLE_W_SHP_DIM_PREP ) a
                          ON f.oms_item_id = a.article_no;                               

							
<br>	
--Final Query 
</br>
INSERT INTO "ROADIE_TRACTOR_SUPPLY_INVOICE_STACKED_JOINED"
SELECT  *
        FROM (
    SELECT 
    r."DELIVERY_DATE",
    r."DELIVERY_DATE_PARSED",
    r."PICK_UP_STORE_NUMBER" AS "Pick_up_Store_Number",
    r."TRACKING_NUMBER" AS "Tracking_Number",
    r."TSC_ORDER_NUMBER" AS "TSC_Order_Number",
    r."CUSTOMER_NAME" AS "Customer_Name",
    r."SKU" AS "SKU",
    r."SKU_DESCRIPTION" AS "SKU_Description",
    r."SHIP_TO_ZIP_CODE" AS "Ship_to_Zip_Code",
    r."SERVICE_LEVEL" AS "Service_Level",
    r."DISTANCE_SHIPPED" AS "Distance_Shipped",
    r."ROADIE_TOTAL_COST" AS "Roadie_Total_Cost",
    r."STORE_CHARGE_TO_CUSTOMER" AS "Store_Charge_to_customer",
    r."STORE_COST_CHARGE_TO_STORE" AS "Store_CostCharge_to_Store",
    r."SSC_SUBSIDIZED" AS "SSC_Subsidized",
    f."TRACKING_NO" AS "TRACKING_NO"
    FROM "ROADIE_TRACTOR_SUPPLY_INVOICE_STACKED" r
    LEFT JOIN ( SELECT  "TRACKING_NO" AS "TRACKING_NO"
                FROM "FREIGHTDETAIL_PREPARED_JOINED"
                GROUP BY "TRACKING_NO")  f
    ON  r."TRACKING_NUMBER" = f."TRACKING_NO"
) a
WHERE (CAST("TRACKING_NO" AS VARCHAR) = '') OR "TRACKING_NO" IS NULL
  
<br>
--DC_3PL_outbound_Productivity_Rate_by_product_segment_prepared
</br>
insert into DC_3PL_OUTBOUND_PRODUCTIVITY_RATE_BY_PRODUCT_SEGMENT_PREPARED
select DISTINCT * from PRODUCTIVITY_RATE_OUTBOUND_REFRESH_PREP_STACKED
WHERE LEFT(YEAR_PERIOD,4) >=2020;

<br>
--DC_3PL_Weighted_Average_Labor_Rates_by_DC_20to22_prepared
</br>
insert into DC_3PL_WEIGHTED_AVERAGE_LABOR_RATES_BY_DC_20TO22_PREPARED
select DISTINCT * from DC_3PL_WEIGHTED_AVERAGE_LABOR_RATES_BY_DC_20TO22_STACKED
WHERE LEFT(YEAR_PERIOD,4) >= 2020;

<br>
--duty_prepared_prepared_1_filtered_stacked
</br>
insert into DUTY_PREPARED_PREPARED_1_FILTERED_STACKED
select 
    Year AS Year,
    Month AS Month,
    month_new AS month_new,
    year_period AS year_period,
    Vendor_ID AS Vendor_ID,
    Vendor_Name AS Vendor_Name,
    ProductItemNo AS ProductItemNo,
    item_int AS item_int,
    New_Total AS New_Total,
    Quantity AS Quantity,
    Avg_Effective_Duty_Rate AS Avg_Effective_Duty_Rate,
    Duty_Per_Unit AS Duty_Per_Unit
from 
(
SELECT * FROM 
	(
		SELECT 
		Year AS Year,
		Month AS Month,
        CASE WHEN Month>=10 THEN TO_CHAR(Month) ELSE '0'||TO_CHAR(Month) END  AS month_new,
		concat(Year,month_new) AS year_period,
		Vendor_ID AS Vendor_ID,
		Vendor_Name AS Vendor_Name,
		ProductItemNo AS ProductItemNo,
		to_Number(ProductItemNo) AS item_int,
		New_Total AS New_Total,
		Quantity AS Quantity,
		Avg_Effective_Duty_Rate AS Avg_Effective_Duty_Rate,
		Duty_Per_Unit AS Duty_Per_Unit
		FROM DUTY_PREPARED
	) DUTY_PREPARED_PREPARED
 WHERE year_period<202207
) DUTY_PREPARED_PREPARED_FILTERED

UNION ALL

SELECT 
    Year AS Year,
    Month AS Month,
    month_new AS month_new,
    year_period AS year_period,
    Vendor_ID AS Vendor_ID,
    Vendor_Name AS Vendor_Name,
    ProductItemNo AS ProductItemNo,
    item_int AS item_int,
    New_Total AS New_Total,
    Quantity AS Quantity,
    Avg_Effective_Duty_Rate AS Avg_Effective_Duty_Rate,
    Duty_Per_Unit AS Duty_Per_Unit 
FROM 
(
SELECT * FROM 
	(
		SELECT 
		Year AS Year,
		Month AS Month,
		CASE WHEN Month>=10 THEN TO_CHAR(Month) ELSE '0'||TO_CHAR(Month) END  AS month_new,
		concat(Year,month_new) AS year_period,
		Vendor_ID AS Vendor_ID,
		Vendor_Name AS Vendor_Name,
		ProductItemNo AS ProductItemNo,
		try_to_Number(ProductItemNo) AS item_int,
		New_Total AS New_Total,
		Quantity AS Quantity,
		Avg_Effective_Duty_Rate AS Avg_Effective_Duty_Rate,
		Duty_Per_Unit AS Duty_Per_Unit
		FROM DUTY_PREPARED_1_STACKED
	) DUTY_PREPARED_PREPARED_1
	WHERE year_period>=202207
) DUTY_PREPARED_PREPARED_1_FILTERED;

<br>
--facility_inbound_20to22
</br>
insert into facility_inbound_20to22  
SELECT  
    ACCT_YEAR AS ACCT_YEAR,
    PERIOD AS PERIOD,
    WEEK_IN_YEAR AS WEEK_IN_YEAR,
    STORE_NO AS STORE_NO,
    STORE_NAME AS STORE_NAME,
    ADDR_LINE_1 AS ADDR_LINE_1,
    CITY AS CITY,
    STATE_POSTAL AS STATE_POSTAL,
    STATE_NAME AS STATE_NAME,
    POSTAL_CODE AS POSTAL_CODE,
    VENDOR_ID AS VENDOR_ID,
    ARTICLE_NO AS ARTICLE_NO,
    ARTICLE_CAT_CODE AS ARTICLE_CAT_CODE,
    ARTICLE_CAT_FULL AS ARTICLE_CAT_FULL,
    DEPT_FULL AS DEPT_FULL,
    VENDOR_RCPT_UNIT_QTY AS VENDOR_RCPT_UNIT_QTY,
    VENDOR_RCPT_COST_AMT AS VENDOR_RCPT_COST_AMT
  FROM 
  (SELECT td.ACCT_YEAR, td.PERIOD, td.WEEK_IN_YEAR, s.STORE_NO, s.STORE_NAME, s.ADDR_LINE_1, s.CITY, s.STATE_POSTAL, s.STATE_NAME, s.POSTAL_CODE, vr.VENDOR_ID, a.ARTICLE_NO, a.ARTICLE_CAT_CODE, LPAD(TRIM(TO_CHAR(a.ARTICLE_CAT_CODE, '9999')), 3, '0') || ' - ' || a.ARTICLE_CAT_NAME AS ARTICLE_CAT_FULL, LPAD(TRIM(TO_CHAR(a.DEPT_CODE, '99')), 2, '0') || ' - ' || a.DEPT_NAME AS DEPT_FULL, SUM(vr.VENDOR_RCPT_UNIT_QTY) as VENDOR_RCPT_UNIT_QTY, SUM(vr.VENDOR_RCPT_COST_AMT) as VENDOR_RCPT_COST_AMT FROM EDW.VENDOR_RECEIPT vr INNER JOIN EDW.TIME_DIMENSION td ON vr.VENDOR_RCPT_DATE = td.CAL_DATE INNER JOIN EDW.STORE s ON s.STORE_NO = vr.STORE_NO AND s.STORE_ACTV_FLAG = 'Y' INNER JOIN EDW.ARTICLE a ON a.ARTICLE_NO = vr.ARTICLE_NO AND a.ARTICLE_ACTV_FLAG = 'Y' GROUP BY 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15)A
  WHERE ACCT_YEAR >= 2020;

<br>
--facility_outbound_20to22
</br>
insert into
  facility_outbound_20to22
SELECT
  ACCT_YEAR AS ACCT_YEAR,
  PERIOD AS PERIOD,
  WEEK_IN_YEAR AS WEEK_IN_YEAR,
  ARTICLE_NO AS ARTICLE_NO,
  ARTICLE_CAT_FULL AS ARTICLE_CAT_FULL,
  VENDOR_ID AS VENDOR_ID,
  DEPT_FULL AS DEPT_FULL,
  STORE_NO AS STORE_NO,
  ADDR_LINE_1 AS ADDR_LINE_1,
  CITY AS CITY,
  STATE_POSTAL AS STATE_POSTAL,
  STATE_NAME AS STATE_NAME,
  POSTAL_CODE AS POSTAL_CODE,
  VENDOR_RCPT_UNIT_QTY AS VENDOR_RCPT_UNIT_QTY,
  VENDOR_RCPT_COST_AMT AS VENDOR_RCPT_COST_AMT
FROM
  (
    SELECT
      td.ACCT_YEAR,
      td.PERIOD,
      td.WEEK_IN_YEAR,
      a.ARTICLE_NO,
      LPAD(
        TRIM(TO_CHAR(a.ARTICLE_CAT_CODE, '9999')),
        3,
        '0'
      ) || ' - ' || a.ARTICLE_CAT_NAME AS ARTICLE_CAT_FULL,
      vr.VENDOR_ID,
      LPAD(TRIM(TO_CHAR(a.DEPT_CODE, '99')), 2, '0') || ' - ' || a.DEPT_NAME AS DEPT_FULL,
      s.STORE_NO,
      s.ADDR_LINE_1,
      s.CITY,
      s.STATE_POSTAL,
      s.STATE_NAME,
      s.POSTAL_CODE,
      SUM(vr.VENDOR_RCPT_UNIT_QTY) as VENDOR_RCPT_UNIT_QTY,
      SUM(vr.VENDOR_RCPT_COST_AMT) as VENDOR_RCPT_COST_AMT
    FROM
      EDW.VENDOR_RECEIPT vr
      INNER JOIN EDW.TIME_DIMENSION td ON vr.VENDOR_RCPT_DATE = td.CAL_DATE
      INNER JOIN EDW.STORE s ON s.STORE_NO = vr.STORE_NO
      AND s.STORE_ACTV_FLAG = 'Y'
      INNER JOIN EDW.ARTICLE a ON a.ARTICLE_NO = vr.ARTICLE_NO
      AND a.ARTICLE_ACTV_FLAG = 'Y'
    GROUP BY
      1,
      2,
      3,
      4,
      5,
      6,
      7,
      8,
      9,
      10,
      11,
      12,
      13
  )
WHERE
  ACCT_YEAR >= 2020;

<br>
--fedex_ups_prepared_filtered
</br>
insert into FEDEX_UPS_PREPARED_FILTERED 
select  * from FEDEX_UPS_PREPARED WHERE Period < 202207;

<br>
--inventory_by_artice_week
</br>

insert INTO INVENTORY_BY_ARTICE_WEEK
SELECT 
    CO_CODE AS CO_CODE,
    ARTICLE_NO AS ARTICLE_NO,
    YEAR_WEEK AS YEAR_WEEK,
    TIME_DIM_KEY AS TIME_DIM_KEY,
    SUM(FIN_INV_AMT) AS FIN_INV_AMT_sum,
    SUM(FIN_INV_53_AMT) AS FIN_INV_53_AMT_sum
  FROM ( 
    SELECT 
        STORE_NO,
        CO_CODE,
        ARTICLE_NO,
        YEAR_WEEK,
        TIME_DIM_KEY,
        SUM_TYPE_CODE,
        VENDOR_ID,
        DC_NO,
        REPL_TYPE_CODE,
        CURRENT_VENDOR_ID,
        CURRENT_DC_NO,
        CURRENT_REPL_TYPE_CODE,
        FIN_INV_QTY,
        FIN_INV_AMT,
        FIN_INV_53_QTY,
        FIN_INV_53_AMT,
        YTD_FIN_INV_QTY,
        YTD_FIN_INV_AMT,
        LYTD_FIN_INV_QTY,
        LYTD_FIN_INV_AMT,
        FIN_INV_REG_RETAIL_AMT
      FROM EDW.VW_STORE_FINANCIAL_INVENTORY_YW
      WHERE CO_CODE = 'TSC' and YEAR_WEEK >= 201952 
    ) dku__beforegrouping
  GROUP BY CO_CODE, ARTICLE_NO, YEAR_WEEK, TIME_DIM_KEY;

<br>
--ITEM_SHIPPING_DIMENSION_BY_ARTICLE_NO_DIM
</br>

insert into ITEM_SHIPPING_DIMENSION_BY_ARTICLE_NO_DIM
SELECT 
    "ARTICLE_NO" AS "ARTICLE_NO",
    "OMS_ITEM_HEIGHT" AS "OMS_ITEM_HEIGHT",
    "OMS_ITEM_LENGTH" AS "OMS_ITEM_LENGTH",
    "OMS_ITEM_WIDTH" AS "OMS_ITEM_WIDTH",
    "OMS_ITEM_WEIGHT" AS "OMS_ITEM_WEIGHT"
  FROM (
    SELECT 
        "OMS_ITEM_PARCEL_SHIP_FLAG" AS "OMS_ITEM_PARCEL_SHIP_FLAG",
        "ARTICLE_CAT_FULL" AS "ARTICLE_CAT_FULL",
        "ARTICLE_NO" AS "ARTICLE_NO",
        "ARTICLE_DESC" AS "ARTICLE_DESC",
        "OMS_ITEM_HEIGHT" AS "OMS_ITEM_HEIGHT",
        "OMS_ITEM_LENGTH" AS "OMS_ITEM_LENGTH",
        "OMS_ITEM_WIDTH" AS "OMS_ITEM_WIDTH",
        "OMS_ITEM_WEIGHT" AS "OMS_ITEM_WEIGHT",
        "ITEM_VOLUME" AS "ITEM_VOLUME",
        "ITEM_DIM_WEIGHT" AS "ITEM_DIM_WEIGHT",
        "ITEM_BILLED_WEIGHT" AS "ITEM_BILLED_WEIGHT",
        "ITEM_MAX_DIM" AS "ITEM_MAX_DIM",
        "ITEM_MIN_DIM" AS "ITEM_MIN_DIM"
      FROM 
      (SELECT  i.OMS_ITEM_PARCEL_SHIP_FLAG, 
LPAD(TRIM(TO_CHAR(a.ARTICLE_CAT_CODE, '9999')), 3, '0') || ' - ' || a.ARTICLE_CAT_NAME as ARTICLE_CAT_FULL, 
a.ARTICLE_NO, a.ARTICLE_DESC, i.OMS_ITEM_HEIGHT, i.OMS_ITEM_LENGTH, i.OMS_ITEM_WIDTH, i.OMS_ITEM_WEIGHT, 
i.OMS_ITEM_LENGTH * i.OMS_ITEM_WIDTH * i.OMS_ITEM_HEIGHT AS ITEM_VOLUME, 
CAST(ITEM_VOLUME / 139 AS NUMBER) AS ITEM_DIM_WEIGHT, 
CASE WHEN ROUND(i.OMS_ITEM_WEIGHT) > ITEM_DIM_WEIGHT THEN ROUND(i.OMS_ITEM_WEIGHT) ELSE ITEM_DIM_WEIGHT END AS ITEM_BILLED_WEIGHT, GREATEST(i.OMS_ITEM_LENGTH, i.OMS_ITEM_WIDTH, i.OMS_ITEM_HEIGHT) AS ITEM_MAX_DIM, LEAST(i.OMS_ITEM_LENGTH, i.OMS_ITEM_WIDTH, i.OMS_ITEM_HEIGHT) AS ITEM_MIN_DIM 
FROM EDW.ARTICLE a LEFT OUTER JOIN EDW.OMS_ITEM i ON to_char(i.OMS_ITEM_ID) = to_char(a.ARTICLE_NO) AND i.OMS_ITEM_ACTV_FLAG = 'Y')
    ) "dku__beforegrouping"
  GROUP BY "ARTICLE_NO", "OMS_ITEM_HEIGHT", "OMS_ITEM_LENGTH", "OMS_ITEM_WIDTH", "OMS_ITEM_WEIGHT";

<br>
--lm_import_manifest_prepared_stacked_distinct
</br>

insert into LM_IMPORT_MANIFEST_PREPARED_STACKED_DISTINCT 
    SELECT DISTINCT *       
      FROM LM_IMPORT_MANIFEST_PREPARED_STACKED;
<br>
-- lm_pricecyts_202211_sf_stacked_prepared
</br>   
insert into LM_PRICECYTS_202211_SF_STACKED_PREPARED 
    SELECT   VAC_NUMBER,
    "BUYER #",
    VENDOR_ID,
    VENDOR_NAME,
    PROMO_TYPE,
    PROMO_DESCRIPTION,
    PAYMENT_TYPE,
    SKU,
    SCAN_DOWN_AMOUNT,
    SKU_DESCRIPTION,
    PROMO_START_DATE,
    PROMO_END_DATE,
    RIGHT_VENDOR_NAME,
    FACT_PARENT_VENDOR_ID,
    FACT_VENDOR_ID,
    SALES_DATE,
    REPLACE(REPLACE(SALES_DATE_PARSED, '0022-', '2022-'), '0023-', '2023-') AS SALES_DATE_PARSED,
    PRICE_ZONE_NAME,
    SUM_SALES_UNITS,
    PRICE_CUT_AMOUNT      
      FROM LM_PRICECYTS_202211_SF_STACKED;

<br>
-- Mixing_Center_Credit
</br>	  
insert into MIXING_CENTER_CREDIT 
SELECT 
    COL_0 AS "YEAR_PERIOD",
    MIXING_CENTER_CREDIT_SUM AS MIXING_CENTER_CREDIT
  FROM (
    SELECT 
        COL_0,
        SUM(MIXING_CENTER_CREDIT) AS MIXING_CENTER_CREDIT_SUM
      FROM (
        SELECT 
            COL_0,
            BATTERY_CORE,
            MIXING_CENTER_CREDIT
          FROM MIXING_CENTER_CREDIT_AND_BATTERY_CORE_STACKED
        ) A
         GROUP BY COL_0
    )B;

<br>
--lm_pdq_prep
</br>
insert into lm_pdq_prep 
SELECT  
    Vendor_no,
    date_parsed,
    TRIM(Amount) AS Amount
FROM (
      SELECT DISTINCT         
       Vendor_no,
       LPAD(SUBSTRING(PaymentDate,1,CHARINDEX ('/',PaymentDate)-1),2,'0') as Month_,
       CHARINDEX ('/',PaymentDate) first_obl ,
       CHARINDEX('/', PaymentDate, CHARINDEX('/', PaymentDate) + 1) as second_obl ,
       SUBSTRING(PaymentDate,CHARINDEX ('/',PaymentDate)+1,2) as day_,
       CASE WHEN LEN(REPLACE(SUBSTRING(PaymentDate,second_obl+1,4),' 0'))=2 THEN CONCAT('20',REPLACE(SUBSTRING(PaymentDate,second_obl+1,4),' 0'))
            ELSE SUBSTRING(PaymentDate,second_obl+1,4) END AS Year_,
         DATE_FROM_PARTS(Year_,Month_,day_) AS date_parsed,
        REPLACE (REPLACE (FlatDollarAmount,',',''),'$','') as Amount        
       FROM LM_POP_PREPARED
       WHERE UPPER(TRIM(PromoType)) = 'PDQ'
)"dku";

<br>
--FREIGHT_DETAIL_SMALL_LTL
</br>
insert into  FREIGHT_DETAIL_SMALL_LTL
SELECT  
    ORDER_DATE,
    ORDER_NO,
    PO_ORDER_NO,
    ORDER_LINE_KEY,
    PO_ORDER_LINE_KEY,
    OMS_ITEM_PARCEL_SHIP_FLAG,
    OMS_ITEM_ID,
    OMS_SHIPMENT_LINE_ITEM_DESC,
    TRACKING_NO,
    TRY_CAST(OMS_SHIP_NODE_KEY AS INTEGER) AS OMS_SHIP_NODE_KEY,
    SHIPMENT_QTY,
    LINE_WEIGHT_FR,
    Dim_Weight,
    Dim_Line_Weight,
    Line_Weight AS LINE_WEIGHT,
    SCAC,
    TRANS_AMT,
    ARTICLE_LENGTH,
    ARTICLE_WIDTH,
    ARTICLE_HEIGHT,
    ARTICLE_WEIGHT
  FROM (
    SELECT
        ORDER_DATE,
        ORDER_NO,
        PO_ORDER_NO,
        ORDER_LINE_KEY,
        PO_ORDER_LINE_KEY,
        OMS_ITEM_PARCEL_SHIP_FLAG,
        OMS_ITEM_ID,
        OMS_SHIPMENT_LINE_ITEM_DESC,
        TRACKING_NO,
        OMS_SHIP_NODE_KEY,
        SHIPMENT_QTY,
        LINE_WEIGHT AS LINE_WEIGHT_FR,
        SCAC,
        TRANS_AMT,
        ARTICLE_LENGTH,
        ARTICLE_WIDTH,
        ARTICLE_HEIGHT,
        Dim_Weight,
        ARTICLE_WEIGHT,
        Dim_Line_Weight,
        New_Line_Weight AS Line_Weight
      FROM (
        SELECT
            ORDER_DATE,
            ORDER_NO,
            PO_ORDER_NO,
            ORDER_LINE_KEY,
            PO_ORDER_LINE_KEY,
            OMS_ITEM_PARCEL_SHIP_FLAG,
            OMS_ITEM_ID,
            OMS_SHIPMENT_LINE_ITEM_DESC,
            TRACKING_NO,
            OMS_SHIP_NODE_KEY,
            SHIPMENT_QTY,
            LINE_WEIGHT,
            SCAC,
            TRANS_AMT,
            ARTICLE_LENGTH,
            ARTICLE_WIDTH,
            ARTICLE_HEIGHT,
            Dim_Weight,
            ARTICLE_WEIGHT,
            Dim_Line_Weight,
            GREATEST(COALESCE(LINE_WEIGHT, 0), COALESCE(Dim_Line_Weight, 0)) AS New_Line_Weight
          FROM (
            SELECT
                ORDER_DATE AS ORDER_DATE,
                ORDER_NO AS ORDER_NO,
                PO_ORDER_NO AS PO_ORDER_NO,
                ORDER_LINE_KEY AS ORDER_LINE_KEY,
                PO_ORDER_LINE_KEY AS PO_ORDER_LINE_KEY,
                OMS_ITEM_PARCEL_SHIP_FLAG AS OMS_ITEM_PARCEL_SHIP_FLAG,
                OMS_ITEM_ID AS OMS_ITEM_ID,
                OMS_SHIPMENT_LINE_ITEM_DESC AS OMS_SHIPMENT_LINE_ITEM_DESC,
                TRACKING_NO AS TRACKING_NO,
                OMS_SHIP_NODE_KEY AS OMS_SHIP_NODE_KEY,
                SHIPMENT_QTY AS SHIPMENT_QTY,
                LINE_WEIGHT AS LINE_WEIGHT,
                SCAC AS SCAC,
                TRANS_AMT AS TRANS_AMT,
                ARTICLE_LENGTH AS ARTICLE_LENGTH,
                ARTICLE_WIDTH AS ARTICLE_WIDTH,
                ARTICLE_HEIGHT AS ARTICLE_HEIGHT,
                Dim_Weight AS Dim_Weight,
                ARTICLE_WEIGHT AS ARTICLE_WEIGHT,
                COALESCE(Dim_Weight, 0) * COALESCE(SHIPMENT_QTY, 0) AS Dim_Line_Weight
              FROM (
                SELECT
                    ORDER_DATE,
                    ORDER_NO,
                    PO_ORDER_NO,
                    ORDER_LINE_KEY,
                    PO_ORDER_LINE_KEY,
                    OMS_ITEM_PARCEL_SHIP_FLAG,
                    OMS_ITEM_ID,
                    OMS_SHIPMENT_LINE_ITEM_DESC,
                    TRACKING_NO,
                    OMS_SHIP_NODE_KEY,
                    SHIPMENT_QTY,
                    LINE_WEIGHT,
                    SCAC,
                    TRANS_AMT,
                    oms_ARTICLE_WEIGHT,
                    oms_ARTICLE_HEIGHT,
                    oms_ARTICLE_LENGTH,
                    oms_ARTICLE_WIDTH,
                    art_ARTICLE_LENGTH,
                    art_ARTICLE_WIDTH,
                    art_ARTICLE_HEIGHT,
                    art_ARTICLE_WEIGHT,
                    ARTICLE_WIDTH,
                    ARTICLE_WEIGHT,
                    ARTICLE_HEIGHT,
                    ARTICLE_LENGTH,
                    COALESCE(CAST(ARTICLE_LENGTH * ARTICLE_WIDTH * ARTICLE_HEIGHT AS DOUBLE) / 139, 0) AS Dim_Weight
                  FROM (
                    SELECT
                        ORDER_DATE,
                        ORDER_NO,
                        PO_ORDER_NO,
                        ORDER_LINE_KEY,
                        PO_ORDER_LINE_KEY,
                        OMS_ITEM_PARCEL_SHIP_FLAG,
                        OMS_ITEM_ID,
                        OMS_SHIPMENT_LINE_ITEM_DESC,
                        TRACKING_NO,
                        OMS_SHIP_NODE_KEY,
                        SHIPMENT_QTY,
                        LINE_WEIGHT,
                        SCAC,
                        TRANS_AMT,
                        oms_ARTICLE_WEIGHT,
                        oms_ARTICLE_HEIGHT,
                        oms_ARTICLE_LENGTH,
                        oms_ARTICLE_WIDTH,
                        art_ARTICLE_LENGTH,
                        art_ARTICLE_WIDTH,
                        art_ARTICLE_HEIGHT,
                        art_ARTICLE_WEIGHT,
                        CASE WHEN oms_ARTICLE_WIDTH IS NULL THEN COALESCE(art_ARTICLE_WIDTH, 0) ELSE COALESCE(oms_ARTICLE_WIDTH, 0) END AS ARTICLE_WIDTH,
                        CASE WHEN oms_ARTICLE_WEIGHT IS NULL THEN COALESCE(art_ARTICLE_WEIGHT, 0) ELSE COALESCE(oms_ARTICLE_WEIGHT, 0) END AS ARTICLE_WEIGHT,
                        CASE WHEN oms_ARTICLE_HEIGHT IS NULL THEN COALESCE(art_ARTICLE_HEIGHT, 0) ELSE COALESCE(oms_ARTICLE_HEIGHT, 0) END AS ARTICLE_HEIGHT,
                        CASE WHEN oms_ARTICLE_LENGTH IS NULL THEN COALESCE(art_ARTICLE_LENGTH, 0) ELSE COALESCE(oms_ARTICLE_LENGTH, 0) END AS ARTICLE_LENGTH
                      FROM FREIGHTDETAIL_PREPARED_JOINED
                    ) __dku_before_xxx
                ) __dku_before_xxx
            ) __dku_before_xxx
        ) __dku_before_xxx
    ) __dku_before_xxx;

    
<br>
--OLT_FUNCTION2
</br>
CREATE
OR REPLACE TEMP FUNCTION "OLT_FUNCTION2"(
    "DOCTYPE" VARCHAR(16777216),
    "DELIVMETHOD" VARCHAR(16777216),
    "CONDVAR" VARCHAR(16777216),
    "STORENO" VARCHAR(16777216)
) RETURNS VARCHAR(16777216) LANGUAGE SQL AS ' CASE WHEN docType = ''0003'' THEN ''RETURNS'' WHEN delivMethod = ''SHP'' and condVar = ''SFS'' THEN ''SFS'' WHEN delivMethod = ''PICK'' and condVar = ''DELIVERY'' THEN ''BODFS'' WHEN delivMethod = ''PICK'' THEN ''BOPIS'' WHEN delivMethod = ''SHP'' AND storeNo IS NULL THEN ''S2H'' WHEN delivMethod = ''SHP'' AND storeNo IS NOT NULL THEN ''S2S'' END ';

<br>
--OMNICHANNEL_SALES_STATUS_PREPARED from below Query VENDOR_ID Excluded
</br>

INSERT INTO OMNICHANNEL_SALES_STATUS_PREPARED
SELECT
    ACCT_YEAR AS ACCT_YEAR,
    YEAR_PERIOD AS YEAR_PERIOD,
    YEAR_WEEK AS YEAR_WEEK,
    OMS_ORDER_NO AS OMS_ORDER_NO,
    OMS_ITEM_ID AS OMS_ITEM_ID,
    TRIM(OMS_ORDER_LINE_KEY) AS OMS_ORDER_LINE_KEY,
    OMS_ITEM_PRIMARY_VENDOR_ID AS OMS_ITEM_PRIMARY_VENDOR_ID,
    OMS_ORDER_LINE_SCHEDULE_SHIP_NODE AS OMS_ORDER_LINE_SCHEDULE_SHIP_NODE,
    OMS_SHIP_NODE_DESC AS OMS_SHIP_NODE_DESC,
    ARTICLE_CAT_FULL AS ARTICLE_CAT_FULL,
    DEMAND_QTY AS DEMAND_QTY,
    DEMAND_SALES AS DEMAND_SALES,
    BOOKED_SALES_QTY AS BOOKED_SALES_QTY,
    BOOKED_SALES_AMT AS BOOKED_SALES_AMT,
    BOOKED_COST_AMT AS BOOKED_COST_AMT,
    SHIPPING_REVENUE AS SHIPPING_REVENUE,
    SHIPPING_DISC AS SHIPPING_DISC,
    ACTUAL_SHIPPING_REVENUE AS ACTUAL_SHIPPING_REVENUE,
    ORDER_LINE_TYPE AS ORDER_LINE_TYPE,
    SCAC AS SCAC,
    SHIP_NODE_TYPE AS SHIP_NODE_TYPE
  FROM
  (
WITH os AS
(
SELECT          td.ACCT_YEAR,
                td.YEAR_PERIOD,
                td.CAL_DATE,
                td.PERIOD,
                td.YEAR_WEEK,
                td.WEEK_IN_YEAR,
                stl.STORE_NO,
                stl.TRANS_NO,
                CASE WHEN stl.BUY_ONLINE_CODE IN ('P', 'R', 'D')
                     THEN 'Y'
                     ELSE 'N'
                END BUY_ONLINE_CODE,
                stl.TRANS_SEQ_NO,
                stl.TERM_NO,
                stl.ORIG_TRANS_NO,
                stl.OMS_ORDER_NO,
                stl.VENDOR_ID,
                ROUND(stl.SALES_QTY * stl.UNIT_PRICE - stl.DISC_AMT, 2) AS SALES_AMT,
                stl.SALES_QTY AS SALES_QTY,
                ROUND(stl.SALES_QTY * stl.UNIT_COST, 2) AS COST_AMT,
                SALES_AMT - COST_AMT AS ITEM_GROSS_MARGIN,
                stl.UNIT_COST,
                stl.UNIT_PRICE,
                a.ARTICLE_NO,
                a.ARTICLE_DESC,
                LPAD(TRIM(TO_CHAR(a.ARTICLE_CAT_CODE, '9999')), 3, '0') || ' - ' || a.ARTICLE_CAT_NAME AS ARTICLE_CAT_FULL
FROM            EDW.VW_SALES stl
INNER JOIN      EDW.VW_TIME_DIMENSION td
ON              stl.TIME_DIM_KEY = td.TIME_DIM_KEY
INNER JOIN      EDW.VW_ARTICLE a
ON              stl.ARTICLE_NO = a.ARTICLE_NO
AND             a.ARTICLE_EDW_ACTV_FLAG = 'Y'
WHERE           (stl.STORE_NO = 5509 OR
                 stl.BUY_ONLINE_CODE IN ('P', 'R', 'D'))
AND             a.ARTICLE_NO <> 8608006
AND             a.ARTICLE_CAT_CODE <> 997
AND             stl.OMS_ORDER_NO NOT BETWEEN 6000000000 AND 6999999999

)
SELECT          max(os.ACCT_YEAR) AS   ACCT_YEAR,
                max(os.YEAR_PERIOD) AS YEAR_PERIOD,
                max(os.YEAR_WEEK) AS   YEAR_WEEK,
                                         o.OMS_ORDER_NO,
                                                     ol.OMS_ITEM_ID,
                                                    ol.OMS_ORDER_LINE_KEY,
                                             i.OMS_ITEM_PRIMARY_VENDOR_ID,
                                            ols2.OMS_ORDER_LINE_SCHEDULE_SHIP_NODE,
                                               ols2.OMS_SHIP_NODE_DESC,
                                               os.ARTICLE_CAT_FULL,
                                               os.VENDOR_ID,
                CASE WHEN rs11.OMS_ORDER_RELEASE_STATUS_TOTAL_QTY IS NOT NULL
                     THEN rs11.OMS_ORDER_RELEASE_STATUS_TOTAL_QTY
                     ELSE ol.OMS_ORDER_LINE_ORIG_ORDER_QTY
                END AS DEMAND_QTY,
                CASE WHEN rs11.OMS_ORDER_RELEASE_STATUS_TOTAL_QTY IS NOT NULL
                     THEN ol.OMS_ORDER_LINE_UNIT_PRICE * rs11.OMS_ORDER_RELEASE_STATUS_TOTAL_QTY
                     ELSE ol.OMS_ORDER_LINE_ORIG_ORDER_QTY * ol.OMS_ORDER_LINE_UNIT_PRICE
                END AS DEMAND_SALES,
                SUM(os.SALES_QTY) AS BOOKED_SALES_QTY,
                SUM(os.SALES_AMT) AS BOOKED_SALES_AMT,
                SUM(os.COST_AMT) AS BOOKED_COST_AMT,
                ZEROIFNULL(lcs.TOTAL_LINE_CHARGE) AS SHIPPING_REVENUE,
                ZEROIFNULL(lcd.TOTAL_LINE_CHARGE) AS SHIPPING_DISC,
                SHIPPING_REVENUE - SHIPPING_DISC AS  ACTUAL_SHIPPING_REVENUE,
CASE WHEN  os.SALES_QTY <= 0 THEN 'Return' 
WHEN ol.OMS_ORDER_LINE_DELIV_METHOD='SHP' and ol.OMS_ORDER_LINE_COND_VARIABLE_1 ='SFS' THEN 'SFS' 
WHEN ol.OMS_ORDER_LINE_DELIV_METHOD='PICK'and ol.OMS_ORDER_LINE_COND_VARIABLE_1 ='DELIVERY' THEN 'BODFS'
WHEN ol.OMS_ORDER_LINE_DELIV_METHOD='PICK'THEN 'BOPIS' WHEN ol.OMS_ORDER_LINE_DELIV_METHOD='SHP' and  ol.OMS_ORDER_LINE_STORE_NO   IS NULL THEN 'S2H'  WHEN ol.OMS_ORDER_LINE_DELIV_METHOD='SHP' and  ol.OMS_ORDER_LINE_STORE_NO   IS NOT NULL THEN 'S2S'
                END AS ORDER_LINE_TYPE,
                CASE WHEN os.SALES_QTY < 0
                     THEN 'Return'
                     ELSE ol.OMS_ORDER_LINE_SCAC
                END AS SCAC,
                CASE WHEN os.SALES_QTY < 0
                     THEN 'Return'
                     WHEN sn1.OMS_SHIP_NODE_TYPE IS NULL
                     THEN 'Vendor'
                     ELSE sn1.OMS_SHIP_NODE_TYPE
                END AS SHIP_NODE_TYPE
FROM            os
INNER JOIN      (SELECT   NULLIF(OMS_ORDER_NO, ' ') AS OMS_ORDER_NO,
                          OMS_ORDER_KEY AS OMS_ORDER_KEY,
                          NULLIF(OMS_DOC_TYPE, ' ') AS OMS_DOC_TYPE,
                          OMS_SHIP_NODE AS OMS_SHIP_NODE
                 FROM     edw.VW_OMS_ORDER
                 GROUP BY 1, 2, 3, 4) o
ON              os.OMS_ORDER_NO = o.OMS_ORDER_NO
INNER JOIN      EDW.VW_OMS_ORDER_INVOICE oi
ON              oi.OMS_ORDER_INVOICE_NO = TO_CHAR(os.TRANS_NO)
INNER JOIN      EDW.VW_OMS_ORDER_INVOICE_LINE oil
ON              oi.OMS_ORDER_INVOICE_KEY = oil.OMS_ORDER_INVOICE_KEY
INNER JOIN      (SELECT   NULLIF(OMS_ITEM_ID, ' ') AS OMS_ITEM_ID,
                          OMS_ORDER_KEY AS OMS_ORDER_KEY,
                          OMS_ORDER_LINE_KEY AS OMS_ORDER_LINE_KEY,
                          NULLIF(OMS_ORDER_LINE_SCAC, ' ') AS OMS_ORDER_LINE_SCAC,
                          OMS_SHIP_NODE_KEY AS OMS_SHIP_NODE_KEY,
                          NULLIF(OMS_ORDER_LINE_DELIV_METHOD, ' ') AS OMS_ORDER_LINE_DELIV_METHOD,
                          NULLIF(OMS_ORDER_LINE_COND_VARIABLE_1, ' ') AS OMS_ORDER_LINE_COND_VARIABLE_1,
                          NULLIF(OMS_ORDER_LINE_STORE_NO, ' ') AS OMS_ORDER_LINE_STORE_NO,
                          OMS_ORDER_LINE_ORIG_ORDER_QTY AS OMS_ORDER_LINE_ORIG_ORDER_QTY,
                          OMS_ORDER_LINE_UNIT_PRICE AS OMS_ORDER_LINE_UNIT_PRICE
                 FROM     edw.VW_OMS_ORDER_LINE
                 GROUP BY 1, 2, 3, 4, 5, 6, 7, 8, 9, 10) ol
ON              os.ARTICLE_NO = ol.OMS_ITEM_ID
AND             ol.OMS_ORDER_LINE_KEY = oil.OMS_ORDER_LINE_KEY
LEFT OUTER JOIN (SELECT     ors1.OMS_ORDER_KEY,
                            ors1.OMS_ORDER_LINE_KEY,
                            ors1.OMS_ORDER_RELEASE_STATUS_TOTAL_QTY,
                            ors1.OMS_ORDER_RELEASE_STATUS,
                            ors2.STATUS_TS
                 FROM       EDW.VW_OMS_ORDER_RELEASE_STATUS ors1
                 INNER JOIN (SELECT   OMS_ORDER_LINE_KEY,
                                      MIN(OMS_ORDER_RELEASE_STATUS_TS) AS STATUS_TS
                             FROM     EDW.VW_OMS_ORDER_RELEASE_STATUS
                             WHERE    OMS_ORDER_RELEASE_STATUS = '1100'
                             GROUP BY 1) ors2
                 ON         ors2.OMS_ORDER_LINE_KEY = ors1.OMS_ORDER_LINE_KEY
                 AND        ors2.STATUS_TS = ors1.OMS_ORDER_RELEASE_STATUS_TS
                 WHERE      ors1.OMS_ORDER_RELEASE_STATUS = '1100'
                 GROUP BY   1, 2, 3, 4, 5) rs11
ON              ol.OMS_ORDER_LINE_KEY = rs11.OMS_ORDER_LINE_KEY
LEFT OUTER JOIN EDW.VW_OMS_SHIPMENT_LINE sl
ON              ol.OMS_ORDER_LINE_KEY = sl.OMS_ORDER_LINE_KEY
AND             sl.OMS_SHIPMENT_LINE_QTY > 0
LEFT OUTER JOIN edw.VW_OMS_SHIPMENT s
ON              s.OMS_SHIPMENT_KEY = sl.OMS_SHIPMENT_KEY
LEFT OUTER JOIN EDW.VW_OMS_SHIP_NODE sn1
ON              s.OMS_SHIPMENT_KEY = sn1.OMS_SHIP_NODE_ID
LEFT OUTER JOIN EDW.VW_OMS_ITEM i
ON              ol.OMS_ITEM_ID = i.OMS_ITEM_ID
LEFT OUTER JOIN (SELECT     ols1.OMS_ORDER_LINE_SCHEDULE_SHIP_NODE,
                            ols1.OMS_ORDER_LINE_KEY,
                            sn2.OMS_SHIP_NODE_DESC,
                            sn2.OMS_SHIP_NODE_TYPE AS NODE_TYPE
                 FROM       EDW.VW_OMS_ORDER_LINE_SCHEDULE ols1
                 INNER JOIN EDW.VW_OMS_SHIP_NODE sn2
                 ON         ols1.OMS_ORDER_LINE_SCHEDULE_SHIP_NODE = sn2.OMS_SHIP_NODE_ID
                 INNER JOIN EDW.VW_OMS_ORDER_RELEASE_STATUS ors
                 ON         ols1.OMS_ORDER_LINE_KEY = ors.OMS_ORDER_LINE_KEY
                 WHERE      ors.OMS_ORDER_RELEASE_STATUS_QTY > 0
                 AND        ols1.OMS_PRODUCT_AVAILABLE_DATE IS NOT NULL
                 GROUP BY   1, 2, 3, 4) ols2
ON              ol.OMS_ORDER_LINE_KEY = ols2.OMS_ORDER_LINE_KEY
LEFT OUTER JOIN (SELECT   OMS_LINE_KEY,
                          SUM(OMS_LINE_CHARGE_TOTAL_AMT) AS TOTAL_LINE_CHARGE
                 FROM     EDW.VW_OMS_LINE_CHARGE
                 WHERE    OMS_CHARGE_CAT = 'Shipping'
                 GROUP BY 1) lcs
ON              ol.OMS_ORDER_LINE_KEY = lcs.OMS_LINE_KEY
LEFT OUTER JOIN (SELECT   OMS_LINE_KEY,
                          SUM(OMS_LINE_CHARGE_TOTAL_AMT) AS TOTAL_LINE_CHARGE
                 FROM     EDW.VW_OMS_LINE_CHARGE
                 WHERE    OMS_CHARGE_CAT = 'ShpOrdTot_Discount' OR
                          OMS_CHARGE_NAME IN ('716209390', '716312394')
                 GROUP BY 1) lcd
ON              ol.OMS_ORDER_LINE_KEY = lcd.OMS_LINE_KEY
GROUP BY       4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 17, 18, 19, 20, 21, 22 );


<br>
--BATTERY_CORE
</br>
insert INTO BATTERY_CORE
SELECT 
"COL_0" AS "YEAR_PERIOD",
SUM("BATTERY_CORE") AS "Battery_Core"
FROM MIXING_CENTER_CREDIT_AND_BATTERY_CORE_STACKED
GROUP BY "COL_0";

<br>
--BOOTH_RENTAL_STACKED_PREPARED_BY_PARENT_VENDOR_INT
</br>
INSERT INTO BOOTH_RENTAL_STACKED_PREPARED_BY_PARENT_VENDOR_INT
(
"PARENT_VENDOR_ID",
 "MERCH_YEAR",
 "allocation_value")
SELECT 
"parent_vendor_int" as "PARENT_VENDOR_ID",
"MERCH_YEAR",
SUM("allocation_value") AS "allocation_value"
FROM (
SELECT 
    "PARENT_VENDOR_ID",
    "MERCH_YEAR",
    "allocation_value",
    TRY_TO_NUMBER("PARENT_VENDOR_ID") AS "parent_vendor_int"
  FROM "BOOTH_RENTAL_STACKED_STG"
  where MERCH_YEAR >= 2020)dku
  GROUP BY 1,2;
<br>
--DC_3PL_inbound_Productivity_Rate_by_product_segment_prepared
</br>
insert INTO "DC_3PL_INBOUND_PRODUCTIVITY_RATE_BY_PRODUCT_SEGMENT_PREPARED"
select 
    DC::BIGINT as DC,
    replace(MONTH,'-','')::BIGINT as YEAR_PERIOD,
    Product_Type:: varchar(4194304) AS Product_Type,
    ROUND(replace(TOTAL,',',''))::DOUBLE as TOTAL,
    ROUND(replace(HOURS,',',''))::DOUBLE as HOURS,
    UPH::DOUBLE AS UPH,
    Productivity_Rate::DOUBLE AS Productivity_Rate
from INBOUND_PRODUCTIVITY_RATE_STG
WHERE MONTH >='2020-00';

<br>
--DC_3PL_Item_Mapping_to_Product_Segment_prepared
</br>
insert INTO DC_3PL_ITEM_MAPPING_TO_PRODUCT_SEGMENT_PREPARED
SELECT 
"Item"::BIGINT,
"Description",
"Merchandise_Category"::BIGINT,
"Carton_Type",
"Product_Type"
FROM "ITEM_MAPPING_TO_PRODUCT_SEGMENT_PREP_STACKED_STG" union_data
 QUALIFY ROW_NUMBER() OVER (PARTITION BY "Item" ORDER BY "Item" ASC NULLS FIRST) =1;

<br>
--DC_3PL_PANDL_PREPARED_BY_COST_CENTER_STACKED
</br>
 insert INTO DC_3PL_PANDL_PREPARED_BY_COST_CENTER_STACKED
 (
 "COST_CENTER",
 "COST_TYPE",
 "YEAR",
 "PERIOD",
 "ACTUAL"
 )
 SELECT 
     "Cost Center" AS "COST_CENTER",
     "Cost Type" AS "COST_TYPE",
     "Year" AS "YEAR",
      "Period" AS "PERIOD",
     SUM(DISTINCT "Actual") AS "ACTUAL"
 FROM "DC_3PL_PANDL_PREPARED"
 WHERE "Cost Type" IS NOT NULL 
 GROUP BY "Cost Center", "Cost Type", "Year", "Period"
 UNION ALL
 SELECT   
     "Cost_Center"::BIGINT AS "COST_CENTER", "Cost_Type" AS "COST_TYPE",   "Year"::BIGINT AS "YEAR",   "Period"::BIGINT AS "PERIOD",   SUM("Actual") AS "ACTUAL"
 FROM "DC_3PL_FIXED_VARIABLE_PL_YEAR_END_2022_THRU_11422_PREPARED"
 WHERE "Cost_Type" IS NOT NULL AND "Year"::BIGINT >= 2022
 GROUP BY "Cost_Type", "Cost_Center", "Year", "Period"
 UNION ALL
SELECT 
     "PREPST"."Cost_Center" AS "COST_CENTER",
     "CSTYP"."COST_TYPE",
     "PREPST"."Year" AS "YEAR",
     "PREPST"."Period" AS "PERIOD",
     SUM(DISTINCT "PREPST"."Actual") AS "ACTUAL"
   FROM "DC3PL_PNL_PREPARED_STACKED" "PREPST"
   LEFT JOIN (SELECT 
     "Cost_Type" AS "COST_TYPE",
     "Account_Number" AS "ACCOUNT_NUMBER"
 FROM "DC_3PL_FIXED_VARIABLE_PL_YEAR_END_2022_THRU_11422_PREPARED"
 WHERE   
 "Cost_Type" IS NOT NULL 
 AND "Cost_Type" != 'EXCLUDE'
 AND "Account_Number" IS NOT NULL) "CSTYP"
 ON "PREPST"."Account_Number" = "CSTYP"."ACCOUNT_NUMBER"
 GROUP BY "CSTYP"."COST_TYPE", "PREPST"."Cost_Center", "PREPST"."Year", "PREPST"."Period";

<br>
--DC_3PL_PANDL_FIXED_COST_BY_COST_CENTER
</br>

insert INTO "DC_3PL_PANDL_FIXED_COST_BY_COST_CENTER"
(
"COST_CENTER",
"YEAR",
"PERIOD",
"ACTUAL"
)
SELECT  "COST_CENTER",
       "YEAR",
       "PERIOD",
       "ACTUAL"
FROM (
SELECT 
    "UNIONED"."COST_CENTER",
    "UNIONED"."YEAR",
    "UNIONED"."PERIOD",
     SUM( "UNIONED"."ACTUAL") AS "ACTUAL"
FROM "DC_3PL_PANDL_PREPARED_BY_COST_CENTER_STACKED" "UNIONED"
WHERE   ("UNIONED"."COST_TYPE" = 'Fixed labor') OR ("UNIONED"."COST_TYPE" = 'Fixed related')
GROUP BY "UNIONED"."COST_CENTER", "UNIONED"."YEAR", "UNIONED"."PERIOD")A 
WHERE "YEAR" >='2020';

<br>
--dc_3pl_PandL_Variable_Cost_by_Cost_Center
</br>
insert INTO "DC_3PL_PANDL_VARIABLE_COST_BY_COST_CENTER"
(
"COST_CENTER",
"YEAR",
"PERIOD",
"ACTUAL_SUM"
)
SELECT  "COST_CENTER",
"YEAR",
"PERIOD",
"ACTUAL_SUM"
FROM (
SELECT 
    "UNIONED"."COST_CENTER",
    "UNIONED"."YEAR",
    "UNIONED"."PERIOD",
    SUM("UNIONED"."ACTUAL") AS "ACTUAL_SUM"
FROM "DC_3PL_PANDL_PREPARED_BY_COST_CENTER_STACKED" "UNIONED"
WHERE ("COST_TYPE" = 'Variable labor') OR ("COST_TYPE" = 'Variable supplies')
GROUP BY "UNIONED"."COST_CENTER", "UNIONED"."YEAR", "UNIONED"."PERIOD")A
WHERE "YEAR" >='2020';


<br>
-- DC_SHRINK_PREPARED_STACKED
</br>
insert INTO DC_SHRINK_PREPARED_STACKED
SELECT
     "ARTICLE"
    ,"ARTICLE_DESCRIPTION"
    ,"USER_NAME"
    ,"MOVEMENT_TYPE"
    ,"POSTING_DATE"
    ,"QUANTITY"
    ,"BUOM"
    ,"AMOUNT_IN_LC"
    ,"CURRENCY"
    ,"SITE"
    ,"REFERENCE"
    ,"RECEIVING_ISSUING_SITE"
    ,"ENTRY_DATE"
    ,"STORAGE_LOCATION"
    ,"PURCHASE_ORDER"
    ,"VENDOR"
    ,"DEBIT_CREDIT_INDICATOR"
  FROM DC_SHRINK_PREPARED
UNION ALL
SELECT
    "Article"
    ,"Article_Description"
    ,"User_name"
    ,"Movement_type"
    ,"Posting_date"
    ,"Quantity"
    ,"BUOM"
    ,"Amount_in_LC"
    ,"Currency"
    ,"Site"
    ,"Reference"
    ,"Receiving_Issuing_site"
    ,"Entry_Date"
    ,"Storage_Location"
    ,"Purchase_order"
    ,"Vendor"
    ,"Debit_Credit_Indicator"
  FROM LM_SHRINK_COMBINED_PREP_STG
  WHERE  "Movement_type" in (711,712,812,811,998,999);

<br>
--ROADIE_TRACTOR_SUPPLY_INVOICE_STACKED_BY_TRACKING_NUMBER
</br>
INSERT INTO  ROADIE_TRACTOR_SUPPLY_INVOICE_STACKED_BY_TRACKING_NUMBER 
SELECT 
    "TRACKING_NUMBER" AS "TRACKING_NUMBER",
    SUM("ROADIE_TOTAL_COST") AS "ROADIE_TOTAL_COST_SUM",
    COUNT( TRACKING_NUMBER) AS "COUNT"
FROM ROADIE_TRACTOR_SUPPLY_INVOICE_STACKED
GROUP BY "TRACKING_NUMBER";

<br>
--FREIGHTDETAIL_PREPARED_JOINED_PREPARED
</br>
	
CREATE OR REPLACE TEMP TABLE FREIGHTDETAIL_PREPARED_JOINED_PREPARED
AS
WITH CTE AS 
(
SELECT 
    CONVERT_TIMEZONE('Etc/UTC', fdp.ORDER_DATE) AS ORDER_DATE,
    fdp.ORDER_NO ,
    fdp.PO_ORDER_NO ,
    trim(fdp.ORDER_LINE_KEY) AS ORDER_LINE_KEY,
    fdp.PO_ORDER_LINE_KEY ,
    fdp.OMS_ITEM_PARCEL_SHIP_FLAG,
    fdp.OMS_ITEM_ID,
    fdp.OMS_SHIPMENT_LINE_ITEM_DESC,
    fdp.TRACKING_NO,
    TRY_CAST(fdp.OMS_SHIP_NODE_KEY AS INT) AS OMS_SHIP_NODE_KEY,
    fdp.SHIPMENT_QTY,
    fdp.LINE_WEIGHT AS LINE_WEIGHT_FR,
    fdp.SCAC,
	TRANS_AMT,
    CASE WHEN fdp.oms_ARTICLE_LENGTH IS NULL THEN COALESCE(fdp.art_ARTICLE_LENGTH, 0) ELSE COALESCE(fdp.oms_ARTICLE_LENGTH, 0) END AS ARTICLE_LENGTH,
    CASE WHEN fdp.oms_ARTICLE_WIDTH IS NULL THEN COALESCE(fdp.art_ARTICLE_WIDTH, 0) ELSE COALESCE(fdp.oms_ARTICLE_WIDTH, 0) END AS ARTICLE_WIDTH,
    CASE WHEN fdp.oms_ARTICLE_HEIGHT IS NULL THEN COALESCE(fdp.art_ARTICLE_HEIGHT, 0) ELSE COALESCE(fdp.oms_ARTICLE_HEIGHT, 0) END AS ARTICLE_HEIGHT,
    CASE WHEN fdp.oms_ARTICLE_WEIGHT IS NULL THEN COALESCE(fdp.art_ARTICLE_WEIGHT, 0) ELSE COALESCE(fdp.oms_ARTICLE_WEIGHT, 0) END AS ARTICLE_WEIGHT
FROM FREIGHTDETAIL_PREPARED_JOINED fdp
)

SELECT 
ORDER_DATE,
ORDER_NO,
PO_ORDER_NO,
ORDER_LINE_KEY,
PO_ORDER_LINE_KEY,
OMS_ITEM_PARCEL_SHIP_FLAG,
OMS_ITEM_ID,
OMS_SHIPMENT_LINE_ITEM_DESC,
TRACKING_NO,
OMS_SHIP_NODE_KEY,
SHIPMENT_QTY,
LINE_WEIGHT_FR,
SCAC,
ARTICLE_LENGTH,
ARTICLE_WIDTH,
ARTICLE_HEIGHT,
ARTICLE_WEIGHT,
TRANS_AMT,
Dim_Weight,
Dim_Line_Weight,
New_Line_Weight as LINE_WEIGHT,
FROM 
(
SELECT * ,GREATEST(COALESCE(LINE_WEIGHT_FR,0),COALESCE(Dim_Line_Weight,0)) as New_Line_Weight
FROM 
(
SELECT 
* ,
COALESCE(Dim_Weight,0)*COALESCE(SHIPMENT_QTY,0) AS Dim_Line_Weight
FROM 
(
SELECT 
ORDER_DATE,
ORDER_NO,
PO_ORDER_NO,
ORDER_LINE_KEY,
PO_ORDER_LINE_KEY,
OMS_ITEM_PARCEL_SHIP_FLAG,
OMS_ITEM_ID,
OMS_SHIPMENT_LINE_ITEM_DESC,
TRACKING_NO,
OMS_SHIP_NODE_KEY,
SHIPMENT_QTY,
LINE_WEIGHT_FR,
SCAC,
TRANS_AMT,
ARTICLE_LENGTH,
ARTICLE_WIDTH,
ARTICLE_HEIGHT,
ARTICLE_WEIGHT,
COALESCE(ARTICLE_LENGTH*ARTICLE_WIDTH*ARTICLE_HEIGHT/139,0) as Dim_Weight
FROM 
CTE fdp
)Dim_Line_Weight
)New_Line_Weight
)FINAL

<br>
--FREIGHT_DETAIL_ROADIE_PREPARED
</br>

INSERT  INTO FREIGHT_DETAIL_ROADIE_PREPARED
(
 ORDER_DATE
,ORDER_NO
,PO_ORDER_NO
,ORDER_LINE_KEY
,PO_ORDER_LINE_KEY
,OMS_ITEM_PARCEL_SHIP_FLAG
,OMS_ITEM_ID
,OMS_SHIPMENT_LINE_ITEM_DESC
,TRACKING_NO
,OMS_SHIP_NODE_KEY
,SHIPMENT_QTY
,LINE_WEIGHT_FR
,SCAC
,ARTICLE_LENGTH
,ARTICLE_WIDTH
,ARTICLE_HEIGHT
,ARTICLE_WEIGHT
,roa_roadie_flag
,roa_Tracking_Number
,roa_Roadie_Total_Cost_sum
,TRANS_AMT
,Dim_Weight
,Dim_Line_Weight
,LINE_WEIGHT
)
SELECT 
ORDER_DATE,
ORDER_NO,
PO_ORDER_NO,
ORDER_LINE_KEY,
PO_ORDER_LINE_KEY,
OMS_ITEM_PARCEL_SHIP_FLAG,
OMS_ITEM_ID,
OMS_SHIPMENT_LINE_ITEM_DESC,
TRACKING_NO,
OMS_SHIP_NODE_KEY,
SHIPMENT_QTY,
LINE_WEIGHT_FR,
SCAC,
ARTICLE_LENGTH,
ARTICLE_WIDTH,
ARTICLE_HEIGHT,
ARTICLE_WEIGHT,
"roa_roadie_flag",
"roa_Tracking_Number",
"roa_Roadie_Total_Cost_sum",
CASE WHEN fdp."TRANS_AMT" IS NULL AND ("roa_roadie_flag" = 1) THEN "roa_Roadie_Total_Cost_sum" ELSE fdp."TRANS_AMT" END AS "TRANS_AMT",
Dim_Weight,
Dim_Line_Weight,
LINE_WEIGHT
FROM FREIGHTDETAIL_PREPARED_JOINED_PREPARED fdp
LEFT JOIN 
   (
   SELECT rts."TRACKING_NUMBER"  AS "roa_Tracking_Number",rts."ROADIE_TOTAL_COST_SUM" AS "roa_Roadie_Total_Cost_sum", 1 AS "roa_roadie_flag" 
   FROM ROADIE_TRACTOR_SUPPLY_INVOICE_STACKED_BY_TRACKING_NUMBER rts
   ) R
 ON TRIM(fdp."TRACKING_NO") = TRIM(R."roa_Tracking_Number");

<br>
--import_charge_by_Year_Period
</br>
insert INTO IMPORT_CHARGE_BY_YEAR_PERIOD
SELECT   "imprt"."Year_Period",
      "imprt"."Dray" as "Dray",
      "imprt"."Expeditors" as "Expeditors" ,
      "imprt"."Storage" as "Storage",
      "imprt"."Accessorial" as "Accessorial",
       "tiout"."tie_out" as tie_out,
       coalesce("imprt"."Dray", 0)+coalesce("imprt"."Expeditors", 0)+coalesce("imprt"."Storage", 0)+coalesce("imprt"."Accessorial", 0)+coalesce("tiout"."tie_out", 0) AS total_charge
FROM IMPORT_CHARGE_PREPARED_FILTERED_STACKED_STG "imprt"
LEFT JOIN TIE_OUT_TO_ACCT_PREPARED_FILTERED_STACKED_STG "tiout" ON "imprt"."Year_Period" = "tiout"."Period"
WHERE "imprt"."Year_Period" >= '202000' AND "tiout". "Period" >= '202000'


<br>
--Import_Dest_mapping_prep
</br>
insert INTO IMPORT_DEST_MAPPING_PREP
SELECT 
    "Facility",
    "Destination_Clean"
FROM IMPORT_DEST_MAPPING_PREP_STACKED_STG
WHERE "Facility" is not NULL 
QUALIFY ROW_NUMBER() OVER (PARTITION BY "Facility", "Destination_Clean" ORDER BY "Destination_Clean" DESC NULLS LAST)= 1;


<br>
--Import_Origin_mapping_prep_stacked_windows_prepared
</br>
insert INTO IMPORT_ORIGIN_MAPPING_PREP_STACKED_WINDOWS_PREPARED
SELECT 
"ORIGIN",
"ORIGIN_CLEAN"
FROM IMPORT_ORIGIN_MAPPING_PREP_STACKED_STG
WHERE "ORIGIN" IS NOT NULL
QUALIFY ROW_NUMBER() OVER (PARTITION BY "ORIGIN", "ORIGIN_CLEAN" ORDER BY "ORIGIN_CLEAN" ASC NULLS FIRST)=1;

<br>
--SCANDOWN_BY_LOG_NO_CLEAN_FLAG
</br>
CREATE OR REPLACE TEMP TABLE  SCANDOWN_BY_LOG_NO_CLEAN_FLAG
AS
SELECT 
"Scan_Down",
"Flat_Fund",
"log_no_clean",
 COUNT(*)  AS "count"
FROM (
SELECT  COMPANY,"Scan_Down","Flat_Fund",REPLACE(REPLACE(TRIM(SUBSTRING("VAC_Number",9,1000)),'-',''),' ','') AS "log_no_clean"
FROM SCANDOWN_NEW_STACKED_STG
WHERE COMPANY ='TSC'
GROUP BY 1,2,3,4
) 
GROUP BY 1,2,3;

<br>
--SCANDOWN_NEW_PREPARED_FILTERED_JOINED_FILTERED_STG
</br>
INSERT INTO SCANDOWN_NEW_PREPARED_FILTERED_JOINED_FILTERED_STG
SELECT  
    mark_upd."Year" AS "MERCH_YEAR",
    mark_upd."Period" ,
    CASE WHEN (mark_upd."Period" = 12) OR (mark_upd."Period" = 11) OR (mark_upd."Period" = 10) 
        THEN mark_upd."Period" 
        ELSE CONCAT('0', IFNULL(TO_VARCHAR(mark_upd."Period"), '')) END AS period_new,            
    CONCAT(IFNULL(TO_VARCHAR(mark_upd."Year"), ''), IFNULL(TO_VARCHAR(period_new), '')) AS "YEAR_PERIOD_NEW",
    mark_upd."Year_Period",
    mark_upd."Log_No",
    REPLACE(REPLACE(mark_upd."Log_No", ' ', ''), '-', '') AS "Log_No_clean",
    mark_upd."Date_Received",
    mark_upd."Buyer_no",
    mark_upd."Vendor_No",
    mark_upd."Vendor",
    mark_upd."Type",
    mark_upd."Description",
    mark_upd."Beg_Date",
    mark_upd."End_Date",
    mark_upd."Funding_Date",
    mark_upd."Payment_form",
    mark_upd."Primary_Description",
    REPLACE(REPLACE(REPLACE(mark_upd."Accrual", ',', ''),'(',''),')','')::BIGINT AS Accrual,
    mark_upd."Adjustment_for_Actuals",
    REPLACE(REPLACE(REPLACE(mark_upd."Total", ',', ''),'(',''),')','')::BIGINT AS Total,
    mark_upd."Prior_Year",
    REPLACE(REPLACE(REPLACE(mark_upd."Current_Year", ',', ''),'(',''),')','')::DOUBLE AS Current_Year,
    mark_upd."Budget",
    mark_upd."Notes",
    mark_upd.LOB,
    mark_upd."Funding_Bucket",
    CASE WHEN mark_upd."Parent_V_number"='#N/A' then NULL::BIGINT ELSE mark_upd."Parent_V_number"::BIGINT END AS "Parent_V_number",
    CASE WHEN mark_upd."Parent_Vname"='#N/A' then NULL ELSE mark_upd."Parent_Vname" END AS "Parent_Vname",
    mark_upd."Pre_Alignment_Buyer_no",  
    scan."Scan_Down",
    scan."Flat_Fund",
    CASE WHEN scan."Flat_Fund" = 'Y' THEN 1 ELSE 0 END AS "markdown_flag",
    CASE WHEN scan."Scan_Down" = 'Y' THEN 1 ELSE 0 END AS "scandown_flag"
  FROM MARKDOWN_UPDATED_STACKED_STG mark_upd
  LEFT JOIN SCANDOWN_BY_LOG_NO_CLEAN_FLAG scan
ON (scan."log_no_clean"=(REPLACE(REPLACE(mark_upd."Log_No", ' ', ''), '-', '')))
WHERE TRIM(UPPER(mark_upd."Funding_Bucket"))='MARKDOWNS'
AND CONCAT(IFNULL(TO_VARCHAR(mark_upd."Year"), ''), IFNULL(TO_VARCHAR(period_new), ''))>=202209;

<br>
--LM_NEW_MARKDOWN_FLAG_GRP
</br>
insert INTO LM_NEW_MARKDOWN_FLAG_GRP
(
    "MERCH_YEAR",
    "YEAR_PERIOD",
    "VENDOR_ID",
    "markdown_flag",
    "allocation_value"
)

SELECT 
"MERCH_YEAR",
"YEAR_PERIOD",
 "Vendor_No",
 "markdown_flag",
 SUM("allocation_value") AS "allocation_value"
FROM 
(
SELECT 
    "Year" AS "MERCH_YEAR",
    "year_period_new" AS "YEAR_PERIOD",
    "Vendor_No" AS "Vendor_No",
    "markdown_flag" AS "markdown_flag",
     "Total" AS "allocation_value"
  FROM SCANDOWN_NEW_PREPARED_FILTERED_JOINED_FILTERED_STG
  WHERE  "markdown_flag" = 1
) Before_Grouping
  Group by 1,2,3,4;

<br>
--SCANDOWN_LOG_SKU
</br>
CREATE OR REPLACE TEMP TABLE SCANDOWN_LOG_SKU
AS
SELECT 
      "log_no_clean",
      "SKU" 
 FROM 
(
SELECT  "SKU" ,"Scan_Down","Flat_Fund",REPLACE(REPLACE(TRIM(SUBSTRING("VAC_Number",9,1000)),'-',''),' ','') AS "log_no_clean"
FROM SCANDOWN_NEW_STACKED_STG
WHERE COMPANY ='TSC'
GROUP BY 1,2,3,4
)
GROUP BY 1,2 ;

<br>
--LM_NEW_SCANDOWN_FLAG_JOINED_SKU
</br>
INSERT INTO LM_NEW_SCANDOWN_FLAG_JOINED_SKU
SELECT 
    "scan"."Year" ,
    "scan"."Period" ,
    "scan"."period_new" ,
    "scan"."year_period_new" ,
    "scan"."Year_Period" ,
    "scan"."Log_No" ,
    "scan"."Log_No_clean" ,
    "scan"."Date_Received" ,
    "scan"."Buyer_no" ,
    "scan"."Vendor_No" ,
    "scan"."Vendor" ,
    "scan"."Type" ,
    "scan"."Description" ,
    "scan"."Beg_Date" ,
    "scan"."End_Date" ,
    "scan"."Funding_Date" ,
    "scan"."Payment_form" ,
    "scan"."Primary_Description" ,
    "scan"."Accrual" ,
    "scan"."Adjustment_for_Actuals" ,
    "scan"."Total" ,
    "scan"."Prior_Year" ,
    "scan"."Current_Year" ,
    "scan"."Budget" ,
    "scan"."Notes" ,
    "scan"."LOB" ,
    "scan"."Funding_Bucket" ,
    "scan"."Parent_V_number" ,
    "scan"."Parent_Vname" ,
    "scan"."Pre_Alignment_Buyer_no" ,
    "scan"."Scan_Down" ,
    "scan"."markdown_flag" ,
    "scan"."scandown_flag" ,
     sku."SKU" 
  FROM SCANDOWN_NEW_PREPARED_FILTERED_JOINED_FILTERED_STG "scan"
  LEFT JOIN SCANDOWN_LOG_SKU sku
    ON "scan"."Log_No_clean" =  sku."log_no_clean"
  WHERE  "year_period_new" >= 202209 AND  "scan"."scandown_flag" = 1 ;

<br>
--lm_vendor_support_fast_rates_stacked
</br>
insert INTO LM_VENDOR_SUPPORT_FAST_RATES_STACKED
SELECT  Vendor,
       202301 AS vendor_support_fast_flag,
       AVG(Fast_Support / 100) AS vendor_support_fast_perc
FROM VENDOR_SUPPORT_202301_PREPARED_STG
WHERE Fast_Support/100 IS NOT NULL
GROUP BY Vendor,
         vendor_support_fast_flag
UNION ALL
SELECT  Vendor,
       202212 AS vendor_support_fast_flag,
       AVG(Fast_Support / 100) AS vendor_support_fast_perc
FROM LM_VENDOR_SUPPORT_FAST_RATES_PREPARED_202212_STG
WHERE Fast_Support/100 IS NOT NULL
GROUP BY Vendor,
         vendor_support_fast_flag
UNION ALL
    SELECT  Vendor,
       support_rate_flag AS vendor_support_fast_flag,
       AVG(Fast_Support / 100) AS vendor_support_fast_perc
FROM VENDOR_SUPPORT_FAST_RATES_CSV_PREP_STG
WHERE Fast_Support/100 IS NOT NULL
GROUP BY Vendor,
         support_rate_flag
UNION ALL
SELECT  Vendor,
       202207 AS vendor_support_fast_flag,
       AVG(Fast_Support / 100) AS vendor_support_fast_perc
FROM LM_VENDOR_SUPPORT_FAST_RATES_PREPARED_STG
WHERE Fast_Support/100 IS NOT NULL
GROUP BY Vendor,
         vendor_support_fast_flag
UNION ALL
SELECT  Child_Vendor,
       202101 AS vendor_support_fast_flag,
       AVG(FAST_adj) AS vendor_support_fast_perc
FROM VENDOR_SUPPORT_FAST_RATE_NEW_PREPARED_STG
GROUP BY Child_Vendor,
         vendor_support_fast_flag;

<br>
--lm_vendor_support_rates_stacked
</br>
insert INTO LM_VENDOR_SUPPORT_RATES_STACKED
SELECT 
    Vendor as VENDOR_ID,
    Parent_Vendor AS PARENT_VENDOR_ID,
    AVG(VENDOR_SUPPORT_FUND/100) AS vendor_support_perc,
    202301 AS support_rate_flag
FROM VENDOR_SUPPORT_202301_PREPARED_STG
WHERE VENDOR_ID IS NOT NULL AND Parent_Vendor IS NOT NULL 
GROUP BY Vendor, PARENT_VENDOR_ID,support_rate_flag
UNION ALL
SELECT 
    Vendor AS VENDOR_ID,
    Parent_Vendor AS PARENT_VENDOR_ID,
    AVG(Vendor_Support_Fund/100) AS vendor_support_perc,
    202212 AS support_rate_flag
FROM LM_VENDOR_SUPPORT_FAST_RATES_PREPARED_202212_STG
WHERE Vendor IS NOT NULL AND Parent_Vendor IS NOT NULL
GROUP BY Vendor, Parent_Vendor,support_rate_flag
UNION ALL
SELECT 
    TRY_TO_NUMBER(Vendor) AS VENDOR_ID,
    TRY_TO_NUMBER(Parent_Vendor) AS PARENT_VENDOR_ID,
    AVG(Vendor_Support_Fund/100) AS vendor_support_perc,
    support_rate_flag AS support_rate_flag
FROM VENDOR_SUPPORT_FAST_RATES_CSV_PREP_STG
WHERE Vendor IS NOT NULL AND PARENT_VENDOR IS NOT NULL 
GROUP BY Vendor, PARENT_VENDOR, support_rate_flag 
UNION ALL
SELECT 
    Vendor AS VENDOR_ID,
    Parent_Vendor AS PARENT_VENDOR_ID,
    AVG(Vendor_Support_Fund/ 100) AS vendor_support_perc,
    202207 AS support_rate_flag
  FROM LM_VENDOR_SUPPORT_FAST_RATES_PREPARED_STG
WHERE Vendor IS NOT NULL AND PARENT_VENDOR IS NOT NULL
GROUP BY Vendor, PARENT_VENDOR,support_rate_flag
UNION ALL
SELECT 
    VENDOR_ID,
    PARENT_VENDOR_ID,
    vendor_support_perc,
    202001 AS support_rate_flag
from (
SELECT 
    Vendor AS VENDOR_ID,
    PARENT_VENDOR AS PARENT_VENDOR_ID,
    "Type",
    AVG(VSF_ADJUSTED) AS vendor_support_perc
  FROM VENDOR_SUPPORT_RATES_NEW_PREPARED_STG
WHERE Vendor IS NOT NULL AND PARENT_VENDOR IS NOT NULL
GROUP BY Vendor, PARENT_VENDOR, "Type"
) srnp
QUALIFY ROW_NUMBER() OVER (PARTITION BY VENDOR_ID, PARENT_VENDOR_ID ORDER BY "Type" ASC NULLS FIRST)=1;


<br>
--COMPANY_PARENT_VENDOR
</br>
insert into  COMPANY_PARENT_VENDOR 
SELECT 
    "VENDOR_ID" AS "VENDOR_ID",
    "PARENT_VENDOR_ID" AS "PARENT_VENDOR_ID"
FROM (
    SELECT 
        "CO_CODE" AS "CO_CODE",
        "VENDOR_ID" AS "VENDOR_ID",
        "FIN_HOLD_CODE" AS "FIN_HOLD_CODE",
        "FIN_HOLD_DESC" AS "FIN_HOLD_DESC",
        "FIN_HOLD_FULL" AS "FIN_HOLD_FULL",
        "FIN_HOLD_DATE" AS "FIN_HOLD_DATE",
        "FREIGHT_TERMS_CODE" AS "FREIGHT_TERMS_CODE",
        "PLANNED_DELIV_DAYS" AS "PLANNED_DELIV_DAYS",
        "PMT_TERMS_CODE" AS "PMT_TERMS_CODE",
        "PMT_TERMS_DESC" AS "PMT_TERMS_DESC",
        "PMT_TERMS_FULL" AS "PMT_TERMS_FULL",
        "PARENT_VENDOR_ID" AS "PARENT_VENDOR_ID"
    FROM EDW.VW_COMPANY_VENDOR 
    ) "dku__beforegrouping"
GROUP BY "VENDOR_ID", "PARENT_VENDOR_ID";

<br>
--oms_item_prepared_by_OMS_ITEM_ID
</br>
insert into  OMS_ITEM_PREPARED_BY_OMS_ITEM_ID 
SELECT 
    "OMS_ITEM_ID",
    "OMS_ITEM_WEIGHT",
    "OMS_ITEM_HEIGHT",
    "OMS_ITEM_LENGTH",
    "OMS_ITEM_WIDTH" 
FROM EDW.OMS_ITEM
GROUP BY "OMS_ITEM_ID", "OMS_ITEM_WEIGHT", "OMS_ITEM_HEIGHT", "OMS_ITEM_LENGTH", "OMS_ITEM_WIDTH";

<br>
--COMPANY_PARENT_VENDOR_PREPARED
</br>
insert into  COMPANY_PARENT_VENDOR_PREPARED 
select 
    "VENDOR_ID",
    PARENT_VENDOR_ID_OLD,
    case 
        when PARENT_VENDOR_ID_OLD = 0 OR  (PARENT_VENDOR_ID_OLD is NULL) then VENDOR_ID
        else PARENT_VENDOR_ID_OLD
    end as PARENT_VENDOR_ID
FROM (
    SELECT 
        VENDOR_ID,
        PARENT_VENDOR_ID AS PARENT_VENDOR_ID_OLD
    FROM COMPANY_PARENT_VENDOR
)"DKU";

<br>
--cash_discounts_prepared_filtered_prepared
</br>
insert into  CASH_DISCOUNTS_PREPARED_FILTERED 
SELECT  *
FROM(
    SELECT 
        DOCUMENT_TYPE ,
        DOCUMENT_NUMBER ,
        POSTING_DATE ,
        AMOUNT_IN_LOCAL_CURRENCY ,
        REFERENCE ,
        POSTING_PERIOD ,
        COST_CENTER ,
        PROFIT_CENTER ,
        FISCAL_YEAR ,
        "TEXT" ,
        "YEAR_MONTH" ,
        PURCHASING_DOCUMENT ,
        DOCUMENT_DATE ,
        OFFSETTING_ACCT_NO ,
        OFFSETTING_ACCOUNT_NAME ,
        G_L_ACCOUNT ,
        USER_NAME ,
        NAME_1 ,
        VENDOR ,
        ENTRY_DATE     
    FROM cash_discounts_prepared
    WHERE ("YEAR_MONTH" != '2022/07' OR "YEAR_MONTH" IS NULL AND '2022/07' IS NOT NULL OR "YEAR_MONTH" IS NOT NULL AND '2022/07' IS NULL) AND ("YEAR_MONTH" != '2022/08' OR "YEAR_MONTH" IS NULL AND '2022/08' IS NOT NULL OR "YEAR_MONTH" IS NOT NULL AND '2022/08' IS NULL)
    UNION ALL
    SELECT 
        DOCUMENT_TYPE ,
        DOCUMENT_NUMBER ,
        POSTING_DATE ,
        AMOUNT_IN_LOCAL_CURRENCY ,
        REFERENCE ,
        POSTING_PERIOD ,
        COST_CENTER ,
        PROFIT_CENTER ,
        FISCAL_YEAR ,
        "TEXT" ,
        "YEAR_MONTH" ,
        PURCHASING_DOCUMENT ,
        DOCUMENT_DATE ,
        OFFSETTING_ACCT_NO ,
        OFFSETTING_ACCOUNT_NAME ,
        G_L_ACCOUNT ,
        USER_NAME ,
        NAME_1 ,
        VENDOR ,
        ENTRY_DATE     
    FROM LC_LM_CASH_DISCOUNTS
    UNION ALL
    SELECT 
       DOCUMENT_TYPE ,
        DOCUMENT_NUMBER ,
        POSTING_DATE ,
        AMOUNT_IN_LOCAL_CURRENCY ,
        REFERENCE ,
        POSTING_PERIOD ,
        COST_CENTER ,
        PROFIT_CENTER ,
        FISCAL_YEAR ,
        "TEXT" ,
        "YEAR_MONTH" ,
        PURCHASING_DOCUMENT ,
        DOCUMENT_DATE ,
        OFFSETTING_ACCT_NO ,
        OFFSETTING_ACCOUNT_NAME ,
        G_L_ACCOUNT ,
        USER_NAME ,
        NAME_1 ,
        VENDOR ,
        ENTRY_DATE  
    FROM LC_LM_CASH_DISCOUNTS_CSV) AS "DKU1"
where "TEXT" != '53100-50  GL 53100 - Allocation' OR "TEXT" IS NULL AND '53100-50  GL 53100 - Allocation' IS NOT NULL OR "TEXT" IS NOT NULL AND '53100-50  GL 53100 - Allocation' IS NULL
 
 
<br>
--CASH_DISCOUNTS_PREPARED_FILTERED_PREPARED
</br>
insert into  CASH_DISCOUNTS_PREPARED_FILTERED_PREPARED 
SELECT 
    DOCUMENT_TYPE ,
    DOCUMENT_NUMBER ,
    POSTING_DATE ,
    AMOUNT_IN_LOCAL_CURRENCY ,
    REFERENCE ,
    POSTING_PERIOD ,
    COST_CENTER ,
    PROFIT_CENTER ,
    FISCAL_YEAR ,
    "TEXT" ,
    REPLACE("YEAR_MONTH", '/', '') AS "YEAR_MONTH",
    PURCHASING_DOCUMENT ,
    DOCUMENT_DATE ,
    OFFSETTING_ACCT_NO ,
    OFFSETTING_ACCOUNT_NAME ,
    G_L_ACCOUNT ,
    USER_NAME ,
    NAME_1 ,
    VENDOR ,
    ENTRY_DATE     
FROM CASH_DISCOUNTS_PREPARED_FILTERED;

<br>
--financial_inventory_yp_prepared_filtered_joined
</br>
insert into  FINANCIAL_INVENTORY_YP_PREPARED_FILTERED_JOINED 
SELECT DISTINCT
    "FIN_INVENT"."CO_CODE" AS "CO_CODE",
    "FIN_INVENT"."STORE_NO" AS "STORE_NO",
    "FIN_INVENT"."ARTICLE_NO" AS "ARTICLE_NO",
    "FIN_INVENT"."TIME_DIM_KEY" AS "TIME_DIM_KEY",
    "FIN_INVENT"."FIN_INV_YEAR_PERIOD" AS "FIN_INV_YEAR_PERIOD",
    "FIN_INVENT"."SUM_TYPE_CODE" AS "SUM_TYPE_CODE",
    "FIN_INVENT"."VENDOR_ID" AS "VENDOR_ID",
    "FIN_INVENT"."DC_NO" AS "DC_NO",
    "FIN_INVENT"."REPL_TYPE_CODE" AS "REPL_TYPE_CODE",
    "FIN_INVENT"."CURRENT_VENDOR_ID" AS "CURRENT_VENDOR_ID",
    "FIN_INVENT"."CURRENT_DC_NO" AS "CURRENT_DC_NO",
    "FIN_INVENT"."CURRENT_REPL_TYPE_CODE" AS "CURRENT_REPL_TYPE_CODE",
    "FIN_INVENT"."FIN_INV_QTY" AS "FIN_INV_QTY",
    "FIN_INVENT"."FIN_INV_AMT" AS "FIN_INV_AMT",
    "FIN_INVENT"."OB_FIN_INV_QTY" AS "OB_FIN_INV_QTY",
    "FIN_INVENT"."OB_FIN_INV_AMT" AS "OB_FIN_INV_AMT",
    "FIN_INVENT"."FIN_INV_13_AMT" AS "FIN_INV_13_AMT",
    "FIN_INVENT"."CALC_RCPT_QTY" AS "CALC_RCPT_QTY",
    "FIN_INVENT"."CALC_RCPT_AMT" AS "CALC_RCPT_AMT",
    "FIN_INVENT"."AVG_FIN_INV_QTY" AS "AVG_FIN_INV_QTY",
    "FIN_INVENT"."AVG_FIN_INV_AMT" AS "AVG_FIN_INV_AMT",
    "DC_3PL_LOCATION"."FACILITY_CODE" AS "FACILITY_CODE",
    "DC_3PL_LOCATION"."FACILITY" AS "FACILITY",
    "DC_3PL_LOCATION"."DC_HIERCHY" AS "DC_HIERCHY",
    "DC_3PL_LOCATION"."DC_3PL" AS "DC_3PL"
FROM (
    SELECT DISTINCT * 
    FROM EDW.VW_FINANCIAL_INVENTORY_YP 
    WHERE FIN_INV_YEAR_PERIOD >= 202000
    AND CO_CODE = 'TSC'
  )"FIN_INVENT"
INNER JOIN DC_3PL_LOCATION_MAPPING_PREPARED "DC_3PL_LOCATION"
ON "FIN_INVENT"."STORE_NO" = "DC_3PL_LOCATION"."FACILITY_CODE";


<br>
--price_cuts_2021_2020_prepared
</br>
insert into  PRICE_CUTS_2021_2020_PREPARED 
SELECT 
    "YEAR_WEEK" AS "YEAR_WEEK",
    "DIST_CHANNEL_CODE" AS "DIST_CHANNEL_CODE",
    "DIST_CHANNEL_DESC" AS "DIST_CHANNEL_DESC",
    "ARTICLE_NUMBER" AS "ARTICLE_NUMBER",
    "ARTICLE_DESCRIPTION" AS "ARTICLE_DESCRIPTION",
    "CATEGORY_FULL" AS "CATEGORY_FULL",
    "CATEGORY_NO" AS "CATEGORY_NO",
    "DEPT_NO" AS "DEPT_NO",
    "DEPT_FULL" AS "DEPT_FULL",
    "LOB_NO" AS "LOB_NO",
    "LOB_FULL" AS "LOB_FULL",
    "BUYER" AS "BUYER",
    "BUYER_FULL" AS "BUYER_FULL",
    "SALES_UNITS" AS "SALES_UNITS",
    "SALES_DOL" AS "SALES_DOL",
    "COST_DOL" AS "COST_DOL",
    "GM_DOL" AS "GM_DOL",
    "FACT_VENDOR_ID" AS "FACT_VENDOR_ID",
    "FACT_VENDOR_NAME" AS "FACT_VENDOR_NAME",
    "FACT_PARENT_VENDOR_ID" AS "FACT_PARENT_VENDOR_ID",
    "VENDOR_ID" AS "VENDOR_ID",
    "SCAN_DOWN" AS "SCAN_DOWN",
    CAST("TOTAL_SCAN_DOWN" AS VARCHAR) AS "TOTAL_SCAN_DOWN",
    "TOTAL_GM_W_SCAN_DOWN" AS "TOTAL_GM_W_SCAN_DOWN",
    "IN_STORE_FLYER_Y_N" AS "IN_STORE_FLYER_Y_N",
    "IMPORT_DOMESTIC" AS "IMPORT_DOMESTIC",
    "FLAT_FUNDING" AS "FLAT_FUNDING",
    "EXCLUDED" AS "EXCLUDED"
  FROM "LC_TEMP_PRICE_CUTS_2021_2020"
UNION ALL
SELECT 
    "YEAR_WEEK" AS "YEAR_WEEK",
    "DIST_CHANNEL_CODE" AS "DIST_CHANNEL_CODE",
    "DIST_CHANNEL_DESC" AS "DIST_CHANNEL_DESC",
    "ARTICLE_NUMBER" AS "ARTICLE_NUMBER",
    "ARTICLE_DESCRIPTION" AS "ARTICLE_DESCRIPTION",
    "CATEGORY_FULL" AS "CATEGORY_FULL",
    "CATEGORY_NO" AS "CATEGORY_NO",
    "DEPT_NO" AS "DEPT_NO",
    "DEPT_FULL" AS "DEPT_FULL",
    "LOB_NO" AS "LOB_NO",
    "LOB_FULL" AS "LOB_FULL",
    "BUYER" AS "BUYER",
    "BUYER_FULL" AS "BUYER_FULL",
    "SALES_UNITS" AS "SALES_UNITS",
    "SALES" AS "SALES_DOL",
    "COST" AS "COST_DOL",
    "GM" AS "GM_DOL",
    "FACT_VENDOR_ID" AS "FACT_VENDOR_ID",
    "FACT_VENDOR_NAME" AS "FACT_VENDOR_NAME",
    "FACT_PARENT_VENDOR_ID" AS "FACT_PARENT_VENDOR_ID",
    "VENDOR_ID" AS "VENDOR_ID",
    "SCAN_DOWN_AMT" AS "SCAN_DOWN",
    "TOTAL_SCAN_DOWN_VALUE" AS "TOTAL_SCAN_DOWN",
    NULL AS "TOTAL_GM_W_SCAN_DOWN",
    NULL AS "IN_STORE_FLYER_Y_N",
    NULL AS "IMPORT_DOMESTIC",
    NULL AS "FLAT_FUNDING",
    NULL AS "EXCLUDED"
  FROM "LC_TEMP_LM_PRICE_CUTS_0722";

<br>
--TSC_FACILITIES_FINAL
</br>
insert into TSC_FACILITIES_PREP_STACKED 
SELECT 
    "FACILITY_CODE" AS "FACILITY_CODE",
    "FACILITY_NAME" AS "FACILITY_NAME",
    "FACILITY_TYPE" AS "FACILITY_TYPE"
FROM (
    SELECT 
        "FACILITY_CODE",
        "FACILITY_NAME",
        CASE 
            WHEN UPPER("FACILITY_TYPE") = 'POP UP CENTER' THEN 'POP UP'
            ELSE "FACILITY_TYPE"
        END AS "FACILITY_TYPE"
    FROM "LC_FACILITY_MAPPING"

    UNION ALL
    SELECT  
        "FACILITY_CODE" AS "FACILITY_CODE",
        "FACILITY_NAME" AS "FACILITY_NAME",
        "FACILITY_TYPE" AS "FACILITY_TYPE"
    FROM 
    (
        SELECT *
        FROM (
            SELECT 
                "F"."FACILITY_CODE" AS "FACILITY_CODE",
                "F"."FACILITY_NAME" AS "FACILITY_NAME",
                "F"."FACILITY_TYPE" AS "FACILITY_TYPE",
                "LM"."FACILITY_CODE" AS "LM_FACILITY_CODE"
            FROM "LC_TSC_FACILITIES" "F"
            LEFT JOIN 
                (SELECT 
                    "FACILITY_CODE",
                    "FACILITY_NAME",
                    CASE 
                        WHEN UPPER("FACILITY_TYPE")  = 'POP UP CENTER' THEN 'POP UP'
                        ELSE "FACILITY_TYPE"
                    END AS "FACILITY_TYPE"
                FROM "LC_FACILITY_MAPPING"
                ) "LM"
            ON  ("F"."FACILITY_CODE" = "LM"."FACILITY_CODE")
            AND (UPPER("F"."FACILITY_NAME") = UPPER("LM"."FACILITY_NAME"))
            AND (UPPER("F"."FACILITY_TYPE") = UPPER("LM"."FACILITY_TYPE"))
            ) "UNFILTERED_QUERY"
        WHERE "LM_FACILITY_CODE" IS NULL
    ) AS "MINI_LEFT_JOIN"
    GROUP BY "FACILITY_CODE", "FACILITY_NAME", "FACILITY_TYPE"

    UNION ALL
    SELECT  
        "FACILITY_CODE" AS "FACILITY_CODE",
        "FACILITY_NAME" AS "FACILITY_NAME",
        "FACILITY_TYPE" AS "FACILITY_TYPE"
    FROM "LC_TSC_FACILITY_MAPPING_CSV"
)AS"MINI_UNION"

UNION ALL
SELECT 
    "FACILITY_CODE" AS "FACILITY_CODE",
    "FACILITY_NAME" AS "FACILITY_NAME",
    "FACILITY_TYPE" AS "FACILITY_TYPE"
FROM (
    SELECT 
        "STORE_NO" AS "FACILITY_CODE",
        "STORE_NAME" AS "FACILITY_NAME",
        "FACILITY_TYPE_STORE" AS "FACILITY_TYPE"
    FROM (
        SELECT 
            "STORE_NO" AS "STORE_NO",
            "STORE_NAME" AS "STORE_NAME",
            'STORE' AS "FACILITY_TYPE_STORE"
        FROM (
            SELECT *
            FROM (
                SELECT 
                    "STORE"."STORE_NO" AS "STORE_NO",
                    "STORE"."STORE_NAME" AS "STORE_NAME",
                    "T_F_P"."FACILITY_CODE" AS "FACILITY_CODE",
                    "T_F_P"."FACILITY_NAME" AS "FACILITY_NAME",
                    "T_F_P"."FACILITY_TYPE" AS "FACILITY_TYPE"
                FROM EDW.VW_STORE "STORE"
                LEFT JOIN (
                    SELECT 
                        "FACILITY_CODE",
                        "FACILITY_NAME",
                        CASE 
                            WHEN UPPER("FACILITY_TYPE")  = 'POP UP CENTER' THEN 'POP UP'
                            ELSE "FACILITY_TYPE"
                        END AS "FACILITY_TYPE"
                    FROM "LC_FACILITY_MAPPING"

                    UNION ALL
                    SELECT 
                        "FACILITY_CODE" AS "FACILITY_CODE",
                        "FACILITY_NAME" AS "FACILITY_NAME",
                        "FACILITY_TYPE" AS "FACILITY_TYPE"
                    FROM 
                    (
                        SELECT *
                        FROM (
                            SELECT 
                                "F"."FACILITY_CODE" AS "FACILITY_CODE",
                                "F"."FACILITY_NAME" AS "FACILITY_NAME",
                                "F"."FACILITY_TYPE" AS "FACILITY_TYPE",
                                "LM"."FACILITY_CODE" AS "LM_FACILITY_CODE"
                            FROM "LC_TSC_FACILITIES" "F"
                            LEFT JOIN 
                                (SELECT 
                                    "FACILITY_CODE",
                                    "FACILITY_NAME",
                                    CASE 
                                        WHEN UPPER("FACILITY_TYPE")  = 'POP UP CENTER' THEN 'POP UP'
                                        ELSE "FACILITY_TYPE"
                                    END AS "FACILITY_TYPE"
                                FROM "LC_FACILITY_MAPPING"
                                ) "LM"
                            ON  ("F"."FACILITY_CODE" = "LM"."FACILITY_CODE")
                            AND (UPPER("F"."FACILITY_NAME") = UPPER("LM"."FACILITY_NAME"))
                            AND (UPPER("F"."FACILITY_TYPE") = UPPER("LM"."FACILITY_TYPE"))
                            ) "UNFILTERED_QUERY"
                        WHERE "LM_FACILITY_CODE" IS NULL
                    ) AS "MINI_LEFT_JOIN"
                    GROUP BY "FACILITY_CODE", "FACILITY_NAME", "FACILITY_TYPE"

                    UNION ALL
                    SELECT 
                        "FACILITY_CODE" AS "FACILITY_CODE",
                        "FACILITY_NAME" AS "FACILITY_NAME",
                        "FACILITY_TYPE" AS "FACILITY_TYPE"
                    FROM "LC_TSC_FACILITY_MAPPING_CSV"
                ) "T_F_P"
                    ON "STORE"."STORE_NO" = "T_F_P"."FACILITY_CODE"
                    where year("STORE"."STORE_UPD_TS") >= 2020
                ) "UNFILTERED_QUERY"
            WHERE "FACILITY_CODE" IS NULL
        )AS "BF_LEFT"
        ) "DKU__BEFOREGROUPING"
    GROUP BY "STORE_NO", "STORE_NAME", "FACILITY_TYPE_STORE"
)AS "STORE_JOIN"

UNION ALL
SELECT 
    "FACILITY_CODE" AS "FACILITY_CODE",
    "FACILITY_NAME" AS "FACILITY_NAME",
    "FACILITY_TYPE" AS "FACILITY_TYPE"
FROM (
    SELECT *
    FROM (
        SELECT 
            "VENDORE_F"."FACILITY_CODE" AS "FACILITY_CODE",
            "VENDORE_F"."FACILITY_NAME" AS "FACILITY_NAME",
            "VENDORE_F"."FACILITY_TYPE" AS "FACILITY_TYPE",
            "T_F"."FACILITY_CODE" AS "TSC_FACILITY_CODE",
            "T_F"."FACILITY_NAME" AS "TSC_FACILITY_NAME",
            "T_F"."FACILITY_TYPE" AS "TSC_FACILITY_TYPE"
        FROM (
            SELECT 
                "VENDOR_ID" AS "FACILITY_CODE",
                "VENDOR_NAME" AS "FACILITY_NAME",
                "FACILITY_TYPE" AS "FACILITY_TYPE"
            FROM (
                SELECT 
                    "VENDOR_ID" AS "VENDOR_ID",
                    "VENDOR_NAME" AS "VENDOR_NAME",
                    'VENDOR' AS "FACILITY_TYPE"
                FROM  EDW.VW_VENDOR
            ) "DKU__BEFOREGROUPING"
            GROUP BY "VENDOR_ID", "VENDOR_NAME", "FACILITY_TYPE"
        ) "VENDORE_F"
        LEFT JOIN (
            SELECT 
                "FACILITY_CODE",
                "FACILITY_NAME",
                CASE 
                    WHEN UPPER("FACILITY_TYPE")  = 'POP UP CENTER' THEN 'POP UP'
                    ELSE "FACILITY_TYPE"
                END AS "FACILITY_TYPE"
            FROM "LC_FACILITY_MAPPING"

            UNION ALL
            SELECT 
                "FACILITY_CODE" AS "FACILITY_CODE",
                "FACILITY_NAME" AS "FACILITY_NAME",
                "FACILITY_TYPE" AS "FACILITY_TYPE"
            FROM 
            (
                SELECT *
                FROM (
                    SELECT 
                        "F"."FACILITY_CODE" AS "FACILITY_CODE",
                        "F"."FACILITY_NAME" AS "FACILITY_NAME",
                        "F"."FACILITY_TYPE" AS "FACILITY_TYPE",
                        "LM"."FACILITY_CODE" AS "LM_FACILITY_CODE"
                    FROM "LC_TSC_FACILITIES" "F"
                    LEFT JOIN 
                        (SELECT 
                            "FACILITY_CODE",
                            "FACILITY_NAME",
                            CASE 
                                WHEN UPPER("FACILITY_TYPE")  = 'POP UP CENTER' THEN 'POP UP'
                                ELSE "FACILITY_TYPE"
                            END AS "FACILITY_TYPE"
                        FROM "LC_FACILITY_MAPPING"
                        ) "LM"
                    ON  ("F"."FACILITY_CODE" = "LM"."FACILITY_CODE")
                    AND (UPPER("F"."FACILITY_NAME") = UPPER("LM"."FACILITY_NAME"))
                    AND (UPPER("F"."FACILITY_TYPE") = UPPER("LM"."FACILITY_TYPE"))
                    ) "UNFILTERED_QUERY"
                WHERE "LM_FACILITY_CODE" IS NULL
            ) AS "MINI_LEFT_JOIN"
            GROUP BY "FACILITY_CODE", "FACILITY_NAME", "FACILITY_TYPE"
            UNION ALL
            SELECT 
                "FACILITY_CODE" AS "FACILITY_CODE",
                "FACILITY_NAME" AS "FACILITY_NAME",
                "FACILITY_TYPE" AS "FACILITY_TYPE"
            FROM "LC_TSC_FACILITY_MAPPING_CSV"
        ) "T_F"
        ON "VENDORE_F"."FACILITY_CODE" = "T_F"."FACILITY_CODE"
        ) "UNFILTERED_QUERY"
    WHERE "TSC_FACILITY_CODE" IS NULL
)AS "VENDORE_JOIN";

<br>
--TSC_FACILITIES_FINAL
</br>
insert into TSC_FACILITIES_FINAL
SELECT 
    "FACILITY_CODE" AS "FACILITY_CODE",
    "FACILITY_NAME" AS "FACILITY_NAME",
    "FACILITY_TYPE_OVERRIDE" AS "FACILITY_TYPE"
FROM (
    SELECT 
        "FACILITY_CODE" AS "FACILITY_CODE",
        "FACILITY_NAME" AS "FACILITY_NAME",
        "FACILITY_TYPE" AS "FACILITY_TYPE",
        "KEEP" AS "KEEP",
        "FACILITY_OVERRIDE" AS "FACILITY_OVERRIDE",
        "FACILITY_TYPE_OVERRIDE" AS "FACILITY_TYPE_OVERRIDE"
    FROM (    
        SELECT *
        FROM (
            SELECT 
                "FACILITY_CODE" AS "FACILITY_CODE",
                "FACILITY_NAME" AS "FACILITY_NAME",
                "FACILITY_TYPE" AS "FACILITY_TYPE",
                "KEEP" AS "KEEP",
                "FACILITY_OVERRIDE" AS "FACILITY_OVERRIDE",
                COALESCE("FACILITY_OVERRIDE", "FACILITY_TYPE") AS "FACILITY_TYPE_OVERRIDE"
            FROM (
                SELECT 
                    "ONION_DATA"."FACILITY_CODE" AS "FACILITY_CODE",
                    "ONION_DATA"."FACILITY_NAME" AS "FACILITY_NAME",
                    "ONION_DATA"."FACILITY_TYPE" AS "FACILITY_TYPE",
                    "SHEET"."KEEP" AS "KEEP",
                    "SHEET"."FACILITY_OVERRIDE" AS "FACILITY_OVERRIDE"
                FROM "TSC_FACILITIES_PREP_STACKED" "ONION_DATA"  
                LEFT JOIN "LC_FACILITY_OVERRIDE" "SHEET"
                    ON ("ONION_DATA"."FACILITY_CODE" = "SHEET"."FACILITY_CODE")
                    AND ("ONION_DATA"."FACILITY_NAME" = "SHEET"."FACILITY_NAME")
                    AND (UPPER("ONION_DATA"."FACILITY_TYPE") = UPPER("SHEET"."FACILITY_TYPE"))
                ) "WITHOUTCOMPUTEDCOLS_QUERY"
            ) "UNFILTERED_QUERY"
        WHERE "KEEP" != 0 OR "KEEP" IS NULL AND 0 IS NOT NULL OR "KEEP" IS NOT NULL AND 0 IS NULL
        )AS "DKU5"
    ) "DKU__BEFOREGROUPING"
GROUP BY "FACILITY_CODE", "FACILITY_NAME", "FACILITY_TYPE_OVERRIDE";


<br>
--vendor_compliance_pivot
</br>
insert into  VENDOR_COMPLIANCE_PIVOT
SELECT 
    "YEAR" AS "YEAR",
    "NUMBER" AS "NUMBER",
    "MONTH" AS "MONTH",
    "PERIOD" AS "PERIOD",
    "YEAR_PERIOD" AS "YEAR_PERIOD",
    "ALLOCATION_VALUE" AS "ALLOCATION_VALUE"
  FROM (SELECT
       *,
     CASE
        WHEN UPPER(MONTH) = 'JANUARY' THEN '01'
        WHEN UPPER(MONTH) = 'FEBRUARY' THEN '02'
        WHEN UPPER(MONTH) = 'MARCH' THEN '03'
        WHEN UPPER(MONTH) = 'APRIL' THEN '04'
        WHEN UPPER(MONTH) = 'MAY' THEN '05'
        WHEN UPPER(MONTH) = 'JUNE' THEN '06'
        WHEN UPPER(MONTH) = 'JULY' THEN '07'
        WHEN UPPER(MONTH) = 'AUGUST' THEN '08'
        WHEN UPPER(MONTH) = 'SEPTEMBER' THEN '09'
        WHEN UPPER(MONTH) = 'OCTOBER' THEN '10'
        WHEN UPPER(MONTH) = 'NOVEMBER' THEN '11'
        WHEN UPPER(MONTH) = 'DECEMBER' THEN '12'
    END AS "PERIOD",
    CONCAT("YEAR", 
            CASE
                WHEN UPPER(MONTH) = 'JANUARY' THEN '01'
                WHEN UPPER(MONTH) = 'FEBRUARY' THEN '02'
                WHEN UPPER(MONTH) = 'MARCH' THEN '03'
                WHEN UPPER(MONTH) = 'APRIL' THEN '04'
                WHEN UPPER(MONTH) = 'MAY' THEN '05'
                WHEN UPPER(MONTH) = 'JUNE' THEN '06'
                WHEN UPPER(MONTH) = 'JULY' THEN '07'
                WHEN UPPER(MONTH) = 'AUGUST' THEN '08'
                WHEN UPPER(MONTH) = 'SEPTEMBER' THEN '09'
                WHEN UPPER(MONTH) = 'OCTOBER' THEN '10'
                WHEN UPPER(MONTH) = 'NOVEMBER' THEN '11'
                WHEN UPPER(MONTH) = 'DECEMBER' THEN '12'
           END) AS "YEAR_PERIOD"
FROM (
        SELECT 
            "YEAR" AS "YEAR",
            "NUMBER" AS "NUMBER",
            ALLOCATION_VALUE,
            "MONTH"
        FROM (
            SELECT 
                "YEAR" AS "YEAR",
                "NUMBER" AS "NUMBER",
                SUM("JANUARY") AS "JANUARY",
                SUM("FEBRUARY") AS "FEBRUARY",
                SUM("MARCH") AS "MARCH",
                SUM("APRIL") AS "APRIL",
                SUM("MAY") AS "MAY",
                SUM("JUNE") AS "JUNE",
                SUM("JULY") AS "JULY",
                SUM("AUGUST") AS "AUGUST",
                SUM("SEPTEMBER") AS "SEPTEMBER",
                SUM("OCTOBER") AS "OCTOBER",
                SUM("NOVEMBER") AS "NOVEMBER",
                SUM("DECEMBER") AS "DECEMBER"
            FROM (
                SELECT
                    "YEAR" AS "YEAR",
                    "NUMBER" AS "NUMBER",
                    "VENDOR" AS "VENDOR",
                    "JANUARY" AS "JANUARY",
                    "FEBRUARY" AS "FEBRUARY",
                    "MARCH" AS "MARCH",
                    "APRIL" AS "APRIL",
                    "MAY" AS "MAY",
                    "JUNE" AS "JUNE",
                    "JULY" AS "JULY",
                    "AUGUST" AS "AUGUST",
                    "SEPTEMBER" AS "SEPTEMBER",
                    "OCTOBER" AS "OCTOBER",
                    "NOVEMBER" AS "NOVEMBER",
                    "DECEMBER" AS "DECEMBER"
                FROM "LC_VENDOR_COMPLIANCE"
                WHERE "YEAR" IS NOT NULL
            ) AS "DKU__BEFOREGROUPING"
            GROUP BY "YEAR", "NUMBER"
        ) AS "DKU__BEFOREFOLDING"
        UNPIVOT(
            "ALLOCATION_VALUE" FOR "MONTH" IN (
            "JANUARY", "FEBRUARY", "MARCH", "APRIL", "MAY", "JUNE",
            "JULY", "AUGUST", "SEPTEMBER", "OCTOBER", "NOVEMBER", "DECEMBER"
        ))AS "DKU_1"
)"DKU_2")AS "DKU7"
WHERE "YEAR_PERIOD" <= 202112

UNION ALL
SELECT 
    "YEAR" AS "YEAR",
    "NUMBER" AS "NUMBER",
    "MONTH" AS "MONTH",
    "PERIOD" AS "PERIOD",
    "YEAR_PERIOD" AS "YEAR_PERIOD",
    "ALLOCATION_VALUE" AS "ALLOCATION_VALUE"
  FROM (SELECT 
    *,
     CASE
        WHEN UPPER(MONTH) = 'JANUARY' THEN '01'
        WHEN UPPER(MONTH) = 'FEBRUARY' THEN '02'
        WHEN UPPER(MONTH) = 'MARCH' THEN '03'
        WHEN UPPER(MONTH) = 'APRIL' THEN '04'
        WHEN UPPER(MONTH) = 'MAY' THEN '05'
        WHEN UPPER(MONTH) = 'JUNE' THEN '06'
        WHEN UPPER(MONTH) = 'JULY' THEN '07'
        WHEN UPPER(MONTH) = 'AUGUST' THEN '08'
        WHEN UPPER(MONTH) = 'SEPTEMBER' THEN '09'
        WHEN UPPER(MONTH) = 'OCTOBER' THEN '10'
        WHEN UPPER(MONTH) = 'NOVEMBER' THEN '11'
        WHEN UPPER(MONTH) = 'DECEMBER' THEN '12'
    END AS "PERIOD",
    CONCAT("YEAR", 
            CASE
                WHEN UPPER(MONTH) = 'JANUARY' THEN '01'
                WHEN UPPER(MONTH) = 'FEBRUARY' THEN '02'
                WHEN UPPER(MONTH) = 'MARCH' THEN '03'
                WHEN UPPER(MONTH) = 'APRIL' THEN '04'
                WHEN UPPER(MONTH) = 'MAY' THEN '05'
                WHEN UPPER(MONTH) = 'JUNE' THEN '06'
                WHEN UPPER(MONTH) = 'JULY' THEN '07'
                WHEN UPPER(MONTH) = 'AUGUST' THEN '08'
                WHEN UPPER(MONTH) = 'SEPTEMBER' THEN '09'
                WHEN UPPER(MONTH) = 'OCTOBER' THEN '10'
                WHEN UPPER(MONTH) = 'NOVEMBER' THEN '11'
                WHEN UPPER(MONTH) = 'DECEMBER' THEN '12'
           END) AS "YEAR_PERIOD"
FROM (
        SELECT 
            "YEAR" AS "YEAR",
            "NUMBER" AS "NUMBER",
            ALLOCATION_VALUE,
            "MONTH"
        FROM (
            SELECT 
                TRY_TO_NUMBER("YEAR") AS "YEAR",
                TRY_TO_NUMBER("NUMBER") AS "NUMBER",
                SUM(TRY_TO_NUMBER("JANUARY")) AS "JANUARY",
                SUM(TRY_TO_NUMBER("FEBRUARY")) AS "FEBRUARY",
                SUM(TRY_TO_NUMBER("MARCH")) AS "MARCH",
                SUM(TRY_TO_NUMBER("APRIL")) AS "APRIL",
                SUM(TRY_TO_NUMBER("MAY")) AS "MAY",
                SUM(TRY_TO_NUMBER("JUNE")) AS "JUNE",
                SUM(TRY_TO_NUMBER("JULY")) AS "JULY",
                SUM(TRY_TO_NUMBER("AUGUST")) AS "AUGUST",
                SUM(TRY_TO_NUMBER("SEPTEMBER")) AS "SEPTEMBER"
            FROM (
                SELECT  *
                FROM "LC_LM_VENDOR_COMPLIANCE"
                WHERE "YEAR"  IS NOT NULL 
            ) AS "DKU__BEFOREGROUPING"
            GROUP BY "YEAR", "NUMBER"
        ) AS "DKU__BEFOREUNPIVOTE"
        UNPIVOT
            ("ALLOCATION_VALUE" FOR "MONTH" IN (
            "JANUARY", "FEBRUARY", "MARCH", "APRIL", "MAY", "JUNE",
            "JULY", "AUGUST", "SEPTEMBER")
        )AS "DKU_2") AS "DKU_1")AS "DKU3"
        
UNION ALL
SELECT 
    "YEAR" AS "YEAR",
    "NUMBER" AS "NUMBER",
    "MONTH" AS "MONTH",
    CAST("PERIOD" AS VARCHAR) AS "PERIOD",
    "YEAR_PERIOD" AS "YEAR_PERIOD",
    "ALLOCATION_VALUE" AS "ALLOCATION_VALUE"
  FROM "LC_LM_VENDOR_COMPLIANCE_202210"
UNION ALL
SELECT 
    "YEAR" AS "YEAR",
    "NUMBER" AS "NUMBER",
    "MONTH" AS "MONTH",
    CAST("PERIOD" AS VARCHAR) AS "PERIOD",
    "YEAR_PERIOD" AS "YEAR_PERIOD",
    "ALLOCATION_VALUE" AS "ALLOCATION_VALUE"
  FROM "LC_LM_VENDOR_COMPLIANCE_202212"
UNION ALL
SELECT 
    "YEAR" AS "YEAR",
    "NUMBER" AS "NUMBER",
    "MONTH" AS "MONTH",
    CAST("PERIOD" AS VARCHAR) AS "PERIOD",
    "YEAR_PERIOD" AS "YEAR_PERIOD",
    "ALLOCATION_VALUE" AS "ALLOCATION_VALUE"
  FROM "LC_LM_VENDOR_COMPLIANCE_202211"
UNION ALL
SELECT 
    "YEAR" AS "YEAR",
    "NUMBER" AS "NUMBER",
    "MONTH" AS "MONTH",
     CASE
        WHEN UPPER(MONTH) = 'JANUARY' THEN '01'
        WHEN UPPER(MONTH) = 'FEBRUARY' THEN '02'
        WHEN UPPER(MONTH) = 'MARCH' THEN '03'
        WHEN UPPER(MONTH) = 'APRIL' THEN '04'
        WHEN UPPER(MONTH) = 'MAY' THEN '05'
        WHEN UPPER(MONTH) = 'JUNE' THEN '06'
        WHEN UPPER(MONTH) = 'JULY' THEN '07'
        WHEN UPPER(MONTH) = 'AUGUST' THEN '08'
        WHEN UPPER(MONTH) = 'SEPTEMBER' THEN '09'
        WHEN UPPER(MONTH) = 'OCTOBER' THEN '10'
        WHEN UPPER(MONTH) = 'NOVEMBER' THEN '11'
        WHEN UPPER(MONTH) = 'DECEMBER' THEN '12'
    END AS "PERIOD",
    CONCAT("YEAR", 
            CASE
                WHEN UPPER(MONTH) = 'JANUARY' THEN '01'
                WHEN UPPER(MONTH) = 'FEBRUARY' THEN '02'
                WHEN UPPER(MONTH) = 'MARCH' THEN '03'
                WHEN UPPER(MONTH) = 'APRIL' THEN '04'
                WHEN UPPER(MONTH) = 'MAY' THEN '05'
                WHEN UPPER(MONTH) = 'JUNE' THEN '06'
                WHEN UPPER(MONTH) = 'JULY' THEN '07'
                WHEN UPPER(MONTH) = 'AUGUST' THEN '08'
                WHEN UPPER(MONTH) = 'SEPTEMBER' THEN '09'
                WHEN UPPER(MONTH) = 'OCTOBER' THEN '10'
                WHEN UPPER(MONTH) = 'NOVEMBER' THEN '11'
                WHEN UPPER(MONTH) = 'DECEMBER' THEN '12'
           END) AS "YEAR_PERIOD", 
    TRY_TO_NUMERIC(TRIM("ALLOCATION_VALUE")) AS "ALLOCATION_VALUE"
  FROM "LC_LM_VENDOR_COMPLIANCE_CSV";


<br>
--COMPANY_ARTICLE_W_BUYER
</br>
insert into  COMPANY_ARTICLE_W_BUYER 
SELECT 
    "ARTICLE_NO" AS "ARTICLE_NO",
    "BUYER_CODE" AS "BUYER_CODE",
    "BUYER_NAME" AS "BUYER_NAME",
    "BUYER_FULL" AS "BUYER_FULL"
  FROM (
    SELECT 
        "CO_CODE",
        "ARTICLE_NO",
        "ARTICLE_REPL_TYPE_CODE",
        "ARTICLE_REPL_TYPE_DESC",
        "ARTICLE_REPL_TYPE_FULL",
        "AGV_FLAG",
        "BUYER_CODE",
        "BUYER_NAME",
        "BUYER_FULL",
        "PLANNED_RETAIL_PRICE",
        "ARTICLE_ONLINE_ONLY_FLAG",
        "ARTICLE_CENTRAL_PICK_FLAG"
      FROM EDW.VW_COMPANY_ARTICLE
      WHERE "CO_CODE" = 'TSC'
    ) "dku__beforegrouping"
  GROUP BY "ARTICLE_NO", "BUYER_CODE", "BUYER_NAME", "BUYER_FULL";
  
  <br>
--lm_pop_prep
  </br>

INSERT INTO lm_pop_prep
SELECT VENDOR_NO,"date_parsed",FLATDOLLARAMOUNT AS Amount
FROM 
(
SELECT VENDOR_NO,REPLACE(FLATDOLLARAMOUNT,',','') AS FLATDOLLARAMOUNT,PAYMENTDATE,
    LPAD(SPLIT_PART(PAYMENTDATE,'/',1),2,0) AS "Month_",
    LPAD(SPLIT_PART(PAYMENTDATE,'/',2),2,0) AS "Day_",
    LEFT(SPLIT_PART(PAYMENTDATE,'/',3),4) AS "year_" ,
    CASE WHEN (LEFT(SPLIT_PART(PAYMENTDATE,'/',3),4)) NOT IN ('2020','2021','2022','2023','2024','2025','2026','2027') THEN CONCAT('20',LEFT(SPLIT_PART(PAYMENTDATE,'/',3),2)) ELSE 
         LEFT(SPLIT_PART(PAYMENTDATE,'/',3),4) END  as "year_Formated",
    CONCAT("year_Formated","Month_","Day_") AS "date_parsed"    
FROM lm_pop_prepared 
WHERE PROMOTYPE ='POP' 
) POP_Prepared;

 